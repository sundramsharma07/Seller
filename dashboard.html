<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Naman Enterprises - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <style>
        * {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }
        
        .sidebar {
            background: linear-gradient(135deg, #1a365d 0%, #2d3748 100%);
        }
        
        .sidebar a.active {
            background: rgba(255, 255, 255, 0.15);
            border-left: 4px solid #3b82f6;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-success:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid #f1f5f9;
        }
        
        .table-row {
            transition: all 0.2s;
        }
        
        .table-row:hover {
            background-color: #f8fafc;
        }
        
        .input-field {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px 14px;
            width: 100%;
            transition: all 0.3s;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .modal-overlay {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        
        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        .scrollbar-thin::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }
        
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        
        .scrollbar-thin::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        .receipt {
            background: white;
            padding: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
        }
        
        /* Animation classes */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        .slide-up {
            animation: slideUp 0.3s ease-out;
        }
        
        .pulse-success {
            animation: pulseSuccess 2s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes pulseSuccess {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Main Dashboard Layout -->
    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <div class="sidebar w-64 text-white hidden md:block">
            <div class="p-6 border-b border-white/10">
                <div class="flex items-center space-x-3">
                    <div class="bg-white/10 p-3 rounded-lg">
                        <i class="fas fa-hard-hat text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold">Naman Enterprises</h1>
                        <p class="text-sm text-white/70">Dashboard</p>
                    </div>
                </div>
            </div>
            
            <div class="p-4 space-y-2">
                <a href="#dashboard" id="menu-dashboard" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-white/10 transition active">
                    <i class="fas fa-tachometer-alt w-6"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#customers" id="menu-customers" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-white/10 transition">
                    <i class="fas fa-users w-6"></i>
                    <span>Customers</span>
                </a>
                <a href="#orders" id="menu-orders" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-white/10 transition">
                    <i class="fas fa-shopping-cart w-6"></i>
                    <span>Orders</span>
                </a>
                <a href="#payments" id="menu-payments" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-white/10 transition">
                    <i class="fas fa-rupee-sign w-6"></i>
                    <span>Payments</span>
                </a>
                <a href="#reports" id="menu-reports" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-white/10 transition">
                    <i class="fas fa-chart-bar w-6"></i>
                    <span>Reports</span>
                </a>
                <a href="#prices" id="menu-prices" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-white/10 transition">
                    <i class="fas fa-tag w-6"></i>
                    <span>Manage Prices</span>
                </a>
            </div>
            
            <div class="p-4 mt-auto border-t border-white/10">
                <button id="logout-btn" class="w-full flex items-center justify-center space-x-2 p-3 rounded-lg hover:bg-white/10 transition">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </button>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="flex-1 flex flex-col">
            <!-- Top Bar -->
            <header class="bg-white border-b border-gray-200 p-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-4">
                        <button id="menu-toggle" class="md:hidden text-gray-600">
                            <i class="fas fa-bars text-xl"></i>
                        </button>
                        <div>
                            <h2 class="text-lg font-semibold text-gray-800" id="current-date"></h2>
                            <p class="text-sm text-gray-600">Welcome back, <span id="user-name"></span></p>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-3">
                        <button id="export-excel-btn" class="btn-success flex items-center space-x-2">
                            <i class="fas fa-file-excel"></i>
                            <span>Export Excel</span>
                        </button>
                    </div>
                </div>
            </header>
            
            <!-- Mobile Sidebar -->
            <div id="mobile-sidebar" class="sidebar fixed inset-0 z-50 transform -translate-x-full transition-transform md:hidden">
                <div class="flex justify-between items-center p-6 border-b border-white/10">
                    <h2 class="text-xl font-bold">Menu</h2>
                    <button id="close-menu" class="text-white">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div class="p-4 space-y-2">
                    <a href="#dashboard" class="menu-item flex items-center space-x-3 p-3 rounded-lg hover:bg-white/10 transition active">
                        <i class="fas fa-tachometer-alt w-6"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="#customers" class="menu-item flex items-center space-x-3 p-3 rounded-lg hover:bg-white/10 transition">
                        <i class="fas fa-users w-6"></i>
                        <span>Customers</span>
                    </a>
                    <a href="#orders" class="menu-item flex items-center space-x-3 p-3 rounded-lg hover:bg-white/10 transition">
                        <i class="fas fa-shopping-cart w-6"></i>
                        <span>Orders</span>
                    </a>
                    <a href="#payments" class="menu-item flex items-center space-x-3 p-3 rounded-lg hover:bg-white/10 transition">
                        <i class="fas fa-rupee-sign w-6"></i>
                        <span>Payments</span>
                    </a>
                    <a href="#reports" class="menu-item flex items-center space-x-3 p-3 rounded-lg hover:bg-white/10 transition">
                        <i class="fas fa-chart-bar w-6"></i>
                        <span>Reports</span>
                    </a>
                    <a href="#manage-prices" class="menu-item flex items-center space-x-3 p-3 rounded-lg hover:bg-white/10 transition">
                        <i class="fas fa-tag w-6"></i>
                        <span>Manage Prices</span>
                    </a>
                </div>
            </div>
            
            <!-- Dashboard Content -->
            <main class="flex-1 p-6 overflow-auto scrollbar-thin" id="main-content">
                <!-- Dashboard Content -->
                <div id="dashboard-content">
                    <!-- Stats Overview -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                        <div class="stat-card">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">Total Customers</p>
                                    <h3 class="text-2xl font-bold text-gray-800" id="total-customers">0</h3>
                                </div>
                                <div class="bg-blue-50 p-3 rounded-full">
                                    <i class="fas fa-users text-blue-600 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">Today's Sales</p>
                                    <h3 class="text-2xl font-bold text-gray-800" id="today-sales">₹0</h3>
                                </div>
                                <div class="bg-green-50 p-3 rounded-full">
                                    <i class="fas fa-rupee-sign text-green-600 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">Pending Payments</p>
                                    <h3 class="text-2xl font-bold text-gray-800" id="pending-payments">₹0</h3>
                                </div>
                                <div class="bg-yellow-50 p-3 rounded-full">
                                    <i class="fas fa-clock text-yellow-600 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">Total Revenue</p>
                                    <h3 class="text-2xl font-bold text-gray-800" id="total-revenue">₹0</h3>
                                </div>
                                <div class="bg-purple-50 p-3 rounded-full">
                                    <i class="fas fa-chart-line text-purple-600 text-xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Quick Actions</h3>
                            <div class="space-y-3">
                                <button id="quick-add-order" class="w-full flex items-center justify-between p-3 rounded-lg border border-gray-200 hover:border-blue-300 hover:bg-blue-50 transition">
                                    <div class="flex items-center space-x-3">
                                        <i class="fas fa-plus text-blue-600"></i>
                                        <span>Add New Order</span>
                                    </div>
                                    <i class="fas fa-chevron-right text-gray-400"></i>
                                </button>
                                
                                <button id="quick-add-payment" class="w-full flex items-center justify-between p-3 rounded-lg border border-gray-200 hover:border-green-300 hover:bg-green-50 transition">
                                    <div class="flex items-center space-x-3">
                                        <i class="fas fa-rupee-sign text-green-600"></i>
                                        <span>Record Payment</span>
                                    </div>
                                    <i class="fas fa-chevron-right text-gray-400"></i>
                                </button>
                                
                                <button id="quick-search-customer" class="w-full flex items-center justify-between p-3 rounded-lg border border-gray-200 hover:border-purple-300 hover:bg-purple-50 transition">
                                    <div class="flex items-center space-x-3">
                                        <i class="fas fa-search text-purple-600"></i>
                                        <span>Search Customer</span>
                                    </div>
                                    <i class="fas fa-chevron-right text-gray-400"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Today's Orders -->
                        <div class="lg:col-span-2 card p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-lg font-semibold text-gray-800">Today's Orders</h3>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">Customer</th>
                                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">Material</th>
                                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">Amount</th>
                                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">Status</th>
                                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">Time</th>
                                        </tr>
                                    </thead>
                                    <tbody id="todays-orders-table" class="divide-y divide-gray-200">
                                        <tr>
                                            <td colspan="5" class="py-8 text-center text-gray-500">
                                                <i class="fas fa-shopping-cart text-3xl mb-2 block mx-auto"></i>
                                                <p>No orders today</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Add Cart Section -->
                    <div class="mb-6">
                        <div class="card p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-lg font-semibold text-gray-800">Shopping Cart</h3>
                                <button id="clear-cart-btn" class="text-red-600 hover:text-red-800">
                                    <i class="fas fa-trash mr-1"></i> Clear Cart
                                </button>
                            </div>
                            
                            <div class="mb-6">
                                <div id="cart-empty" class="text-center py-8">
                                    <i class="fas fa-shopping-cart text-4xl text-gray-300 mb-3"></i>
                                    <p class="text-gray-500">Your cart is empty</p>
                                    <p class="text-sm text-gray-400 mt-1">Add products from the form below</p>
                                </div>
                                
                                <div id="cart-items" class="hidden">
                                    <div class="overflow-x-auto">
                                        <table class="w-full">
                                            <thead class="bg-gray-50">
                                                <tr>
                                                    <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">Product</th>
                                                    <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">Category</th>
                                                    <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">Quantity</th>
                                                    <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">Unit Price</th>
                                                    <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">Total</th>
                                                    <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="cart-items-table" class="divide-y divide-gray-200">
                                                <!-- Cart items will be inserted here -->
                                            </tbody>
                                            <tfoot id="cart-summary" class="bg-gray-50">
                                                <!-- Cart summary will be inserted here -->
                                            </tfoot>
                                        </table>
                                    </div>
                                    
                                    <div class="mt-4 flex justify-between items-center">
                                        <div class="text-lg font-semibold" id="cart-total-display">
                                            Cart Total: ₹0
                                        </div>
                                        <button id="checkout-btn" class="btn-primary">
                                            <i class="fas fa-shopping-bag mr-2"></i>Proceed to Checkout
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex space-x-3">
                                <button id="add-to-cart-btn" class="btn-primary flex-1">
                                    <i class="fas fa-cart-plus mr-2"></i>Add to Cart
                                </button>
                                <button onclick="generateReceipt()" class="btn-success flex-1">
                                    <i class="fas fa-receipt mr-2"></i>Generate Receipt
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Customer Form & Order -->
                    <div id="customer-form-container" class="card p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-6">Customer Details & Product Selection</h3>
                        <form id="customer-order-form" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Customer Name *</label>
                                    <input type="text" id="customer-name" class="input-field" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number *</label>
                                    <input type="tel" id="customer-phone" class="input-field" required>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Address</label>
                                <textarea id="customer-address" rows="2" class="input-field"></textarea>
                            </div>
                            
                            <!-- Product Selection Section -->
                            <div class="border-t border-gray-200 pt-4">
                                <h4 class="text-md font-semibold text-gray-800 mb-4">Add Product to Cart</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Category *</label>
                                        <select id="category-select" class="input-field" required onchange="updateProductOptions()">
                                            <option value="">Select Category</option>
                                            <option value="cement">Cement</option>
                                            <option value="rods">Steel Rods</option>
                                            <option value="sand">Sand</option>
                                            <option value="stone">Stone Chips</option>
                                            <option value="chemical">Chemicals</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Product *</label>
                                        <select id="product-select" class="input-field" required onchange="updateQuantityOptions()">
                                            <option value="">Select Product</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Quantity *</label>
                                        <div class="flex space-x-2">
                                            <input type="number" id="material-quantity" min="0.1" step="0.1" value="1" class="input-field" required>
                                            <select id="unit-select" class="input-field w-32">
                                                <option value="bags">Bags</option>
                                                <option value="bundles">Bundles</option>
                                                <option value="pcs">Pieces</option>
                                                <option value="trailers">Trailers</option>
                                                <option value="liters">Liters</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Unit Price (₹)</label>
                                        <input type="number" id="unit-price" class="input-field bg-gray-50" readonly>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Item Total (₹)</label>
                                        <input type="number" id="order-amount" class="input-field bg-gray-100 font-semibold" readonly>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Checkout Section (Will be shown during checkout) -->
                            <div id="checkout-section" class="hidden border-t border-gray-200 pt-4">
                                <h4 class="text-md font-semibold text-gray-800 mb-4">Checkout & Payment</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Payment Mode *</label>
                                        <select id="payment-mode" class="input-field" required>
                                            <option value="cash">Cash</option>
                                            <option value="credit">Credit</option>
                                            <option value="partial">Partial</option>
                                        </select>
                                    </div>
                                    <div id="advance-container" class="hidden">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Advance Amount (₹)</label>
                                        <input type="number" id="advance-amount" class="input-field">
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Order Notes</label>
                                    <textarea id="order-notes" rows="2" class="input-field" placeholder="Any additional information..."></textarea>
                                </div>
                            </div>
                            
                            <!-- Updated Submit Button -->
                            <div class="flex space-x-4 pt-4" id="form-buttons">
                                <button type="submit" id="save-order-btn" class="btn-primary flex-1 py-3 hidden">
                                    <i class="fas fa-save mr-2"></i>Complete Order
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Customers Content -->
                <div id="customers-content" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">All Customers</h2>
                        <div class="flex space-x-3">
                            <input type="text" id="search-customer-input" class="input-field w-64" placeholder="Search customers...">
                            <button id="export-customers-btn" class="btn-success">
                                <i class="fas fa-file-excel mr-2"></i>Export
                            </button>
                        </div>
                    </div>
                    
                    <div class="card overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">Customer ID</th>
                                        <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">Name</th>
                                        <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">Phone</th>
                                        <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">Address</th>
                                        <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">Total Orders</th>
                                        <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">Total Amount</th>
                                        <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">Balance</th>
                                        <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="all-customers-table" class="divide-y divide-gray-200">
                                    <!-- Customer rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Orders Content -->
                <div id="orders-content" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">All Orders</h2>
                        <div class="flex space-x-3">
                            <input type="text" id="date-filter" class="input-field w-48" placeholder="Select Date">
                            <select id="status-filter" class="input-field w-40">
                                <option value="">All Status</option>
                                <option value="paid">Paid</option>
                                <option value="pending">Pending</option>
                                <option value="partial">Partial</option>
                            </select>
                            <button id="export-orders-btn" class="btn-success">
                                <i class="fas fa-file-excel mr-2"></i>Export
                            </button>
                        </div>
                    </div>
                    
                    <div class="card overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">Order ID</th>
                                        <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">Customer</th>
                                        <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">Product</th>
                                        <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">Quantity</th>
                                        <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">Amount</th>
                                        <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">Payment Mode</th>
                                        <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">Status</th>
                                        <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">Date</th>
                                        <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="all-orders-table" class="divide-y divide-gray-200">
                                    <!-- Order rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Payments Content -->
                <div id="payments-content" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">All Payments</h2>
                        <div class="flex space-x-3">
                            <input type="text" id="payment-date-filter" class="input-field w-48" placeholder="Select Date">
                            <button id="export-payments-btn" class="btn-success">
                                <i class="fas fa-file-excel mr-2"></i>Export
                            </button>
                        </div>
                    </div>
                    
                    <div class="card overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">Payment ID</th>
                                        <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">Customer</th>
                                        <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">Amount</th>
                                        <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">Payment Mode</th>
                                        <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">Reference</th>
                                        <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">Date</th>
                                        <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="all-payments-table" class="divide-y divide-gray-200">
                                    <!-- Payment rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Reports Content -->
                <div id="reports-content" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Reports & Analytics</h2>
                        <div class="flex space-x-3">
                            <input type="text" id="report-start-date" class="input-field w-40" placeholder="Start Date">
                            <input type="text" id="report-end-date" class="input-field w-40" placeholder="End Date">
                            <button id="generate-report-btn" class="btn-success">
                                <i class="fas fa-chart-bar mr-2"></i>Generate Report
                            </button>
                        </div>
                    </div>
                    
                    <!-- Data Protection Center - NEW SECTION ADDED -->
                    <div class="card p-6 mb-6 border-2 border-green-200">
                        <h3 class="text-lg font-semibold text-green-800 mb-4">
                            <i class="fas fa-shield-alt mr-2"></i>Data Protection Center
                        </h3>
                        
                        <div class="space-y-4">
                            <!-- Backup Button -->
                            <div class="p-4 bg-blue-50 rounded-lg">
                                <button onclick="backupAllData()" 
                                        class="btn-primary w-full mb-2">
                                    <i class="fas fa-download mr-2"></i>Step 1: Create Backup File
                                </button>
                                <p class="text-sm text-gray-600">Downloads all data to your computer</p>
                            </div>
                            
                            <!-- Google Drive Instructions -->
                            <div class="p-4 bg-green-50 rounded-lg">
                                <div class="flex items-center mb-2">
                                    <i class="fab fa-google-drive text-green-600 mr-2"></i>
                                    <span class="font-medium">Step 2: Save to Google Drive</span>
                                </div>
                                <ol class="text-sm text-gray-700 list-decimal pl-5 space-y-1">
                                    <li>Open <a href="https://drive.google.com" target="_blank" class="text-blue-600 underline">drive.google.com</a></li>
                                    <li>Create folder "Business Backups"</li>
                                    <li>Drag downloaded file into this folder</li>
                                    <li>Rename with today's date</li>
                                </ol>
                                <p class="text-xs text-gray-500 mt-2">Uses your free 15GB storage</p>
                            </div>
                            
                            <!-- Restore Warning -->
                            <div class="p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                                <input type="file" id="restore-file" accept=".json" class="hidden" 
                                       onchange="restoreFromBackup(this.files[0])">
                                <button onclick="document.getElementById('restore-file').click()" 
                                        class="btn-success w-full mb-2">
                                    <i class="fas fa-upload mr-2"></i>Restore from Backup (⚠️ Use Only if Data Lost)
                                </button>
                                <p class="text-sm text-red-600 font-medium">
                                    <i class="fas fa-exclamation-triangle mr-1"></i>
                                    WARNING: This replaces ALL current data!
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Sales Summary</h3>
                            <div id="sales-summary" class="space-y-3">
                                <!-- Sales summary will be inserted here -->
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Product Wise Sales</h3>
                            <div id="product-sales" class="space-y-3">
                                <!-- Product sales will be inserted here -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Daily Transaction Report</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">Date</th>
                                        <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">Total Orders</th>
                                        <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">Total Amount</th>
                                        <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">Payments Received</th>
                                        <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">New Customers</th>
                                        <th class="py-3 px-4 text-left text-sm font-medium text-gray-700">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="daily-report-table" class="divide-y divide-gray-200">
                                    <!-- Daily report rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Manage Prices Content -->
                <div id="prices-content" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Manage Product Prices</h2>
                        <button id="add-new-product-btn" class="btn-primary">
                            <i class="fas fa-plus mr-2"></i>Add New Product
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Cement Prices -->
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-cube mr-2 text-blue-600"></i>Cement Prices
                            </h3>
                            <div class="space-y-4" id="cement-prices">
                                <!-- Cement price items will be inserted here -->
                            </div>
                        </div>
                        
                        <!-- Steel Rod Prices -->
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-grip-lines mr-2 text-red-600"></i>Steel Rod Prices
                            </h3>
                            <div class="space-y-4" id="rod-prices">
                                <!-- Rod price items will be inserted here -->
                            </div>
                        </div>
                        
                        <!-- Sand & Stone Prices -->
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-mountain mr-2 text-yellow-600"></i>Sand & Stone Prices
                            </h3>
                            <div class="space-y-4" id="sand-stone-prices">
                                <!-- Sand & stone price items will be inserted here -->
                            </div>
                        </div>
                        
                        <!-- Chemical Prices -->
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-flask mr-2 text-green-600"></i>Chemical Prices
                            </h3>
                            <div class="space-y-4" id="chemical-prices">
                                <!-- Chemical price items will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Modals -->
    <!-- Payment Modal -->
    <div id="payment-modal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Record Payment</h3>
            <form id="payment-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Customer *</label>
                    <select id="payment-customer" class="input-field" required>
                        <option value="">Select Customer</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Amount (₹) *</label>
                    <input type="number" id="payment-amount" class="input-field" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Payment Mode *</label>
                    <select id="payment-mode-select" class="input-field" required>
                        <option value="cash">Cash</option>
                        <option value="bank">Bank Transfer</option>
                        <option value="upi">UPI</option>
                        <option value="cheque">Cheque</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Reference</label>
                    <input type="text" id="payment-reference" class="input-field" placeholder="Transaction ID, etc.">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-payment" class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg">
                        Cancel
                    </button>
                    <button type="submit" class="btn-primary px-4 py-2">
                        Save Payment
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Search Modal -->
    <div id="search-modal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Search Customer</h3>
            <div class="mb-6">
                <input type="text" id="search-input" class="input-field" placeholder="Search by name or phone number...">
            </div>
            <div id="search-results" class="space-y-3">
                <p class="text-gray-500 text-center py-4">Start typing to search</p>
            </div>
        </div>
    </div>
    
    <!-- Receipt Modal -->
    <div id="receipt-modal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-semibold text-gray-800">Order Receipt</h3>
                <div class="flex space-x-2">
                    <button onclick="printReceipt()" class="btn-primary">
                        <i class="fas fa-print mr-2"></i>Print
                    </button>
                    <button onclick="saveReceipt()" class="btn-success">
                        <i class="fas fa-save mr-2"></i>Save to Excel
                    </button>
                </div>
            </div>
            <div id="receipt-content" class="receipt">
                <!-- Receipt content will be inserted here -->
            </div>
        </div>
    </div>
    
    <!-- Product Price Modal -->
    <div id="price-modal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
            <h3 class="text-lg font-semibold text-gray-800 mb-4" id="price-modal-title">Edit Product Price</h3>
            <form id="price-form" class="space-y-4">
                <input type="hidden" id="edit-product-id">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Product Name *</label>
                    <input type="text" id="edit-product-name" class="input-field" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Category *</label>
                    <select id="edit-product-category" class="input-field" required>
                        <option value="cement">Cement</option>
                        <option value="rods">Steel Rods</option>
                        <option value="sand">Sand</option>
                        <option value="stone">Stone Chips</option>
                        <option value="chemical">Chemicals</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Brand/Type</label>
                    <input type="text" id="edit-product-brand" class="input-field">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Unit *</label>
                    <select id="edit-product-unit" class="input-field" required>
                        <option value="bags">Bags</option>
                        <option value="bundles">Bundles</option>
                        <option value="pcs">Pieces</option>
                        <option value="trailers">Trailers</option>
                        <option value="liters">Liters</option>
                        <option value="kg">Kilograms</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Price (₹) *</label>
                    <input type="number" id="edit-product-price" class="input-field" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                    <textarea id="edit-product-desc" rows="2" class="input-field"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closePriceModal()" class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg">
                        Cancel
                    </button>
                    <button type="submit" class="btn-primary px-4 py-2">
                        Save Price
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Checkout Modal -->
    <div id="checkout-modal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">Order Summary & Checkout</h3>
                <button onclick="closeCheckoutModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Customer Details -->
                <div>
                    <h4 class="font-semibold text-gray-700 mb-3">Customer Details</h4>
                    <div class="bg-gray-50 p-4 rounded-lg space-y-2">
                        <div><strong>Name:</strong> <span id="checkout-customer-name"></span></div>
                        <div><strong>Phone:</strong> <span id="checkout-customer-phone"></span></div>
                        <div><strong>Address:</strong> <span id="checkout-customer-address"></span></div>
                    </div>
                    
                    <h4 class="font-semibold text-gray-700 mb-3 mt-4">Payment Details</h4>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Payment Mode *</label>
                            <select id="checkout-payment-mode" class="input-field" required>
                                <option value="cash">Cash</option>
                                <option value="credit">Credit</option>
                                <option value="partial">Partial</option>
                            </select>
                        </div>
                        <div id="checkout-advance-container" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Advance Amount (₹)</label>
                            <input type="number" id="checkout-advance-amount" class="input-field">
                        </div>
                    </div>
                </div>
                
                <!-- Order Summary -->
                <div>
                    <h4 class="font-semibold text-gray-700 mb-3">Order Summary</h4>
                    <div class="bg-gray-50 p-4 rounded-lg mb-4">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="py-2 px-3 text-left text-sm">Product</th>
                                        <th class="py-2 px-3 text-left text-sm">Qty</th>
                                        <th class="py-2 px-3 text-left text-sm">Total</th>
                                    </tr>
                                </thead>
                                <tbody id="checkout-items-table">
                                    <!-- Items will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-4 pt-4 border-t border-gray-300">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-medium">Subtotal:</span>
                                <span>₹<span id="checkout-subtotal">0</span></span>
                            </div>
                            <div class="flex justify-between items-center text-lg font-bold">
                                <span>Total Amount:</span>
                                <span>₹<span id="checkout-total">0</span></span>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                        <textarea id="checkout-notes" rows="2" class="input-field" placeholder="Any additional information..."></textarea>
                    </div>
                    
                    <div class="mt-6 flex space-x-3">
                        <button onclick="closeCheckoutModal()" class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg flex-1">
                            Cancel
                        </button>
                        <button onclick="completeCheckout()" class="btn-primary flex-1">
                            <i class="fas fa-check mr-2"></i>Confirm Order
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 bg-green-600 text-white px-4 py-3 rounded-lg shadow-lg z-50 transform translate-y-20 transition-transform">
        <div class="flex items-center space-x-3">
            <i class="fas fa-check-circle"></i>
            <span id="toast-message">Operation successful</span>
        </div>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        const STORAGE_KEYS = {
            USERS: 'buildpro_users',
            CURRENT_USER: 'buildpro_current_user',
            CUSTOMERS: 'buildpro_customers_v4',
            ORDERS: 'buildpro_orders_v4',
            PAYMENTS: 'buildpro_payments_v4',
            PRODUCTS: 'buildpro_products_v4',
            DAILY_REPORTS: 'buildpro_daily_reports_v4',
            CUSTOMER_EXCEL: 'buildpro_customer_excel_v4'
        };
        
        const ROD_PIECES = {
            '6mm': 20,
            '8mm': 12,
            '10mm': 8,
            '12mm': 5,
            '16mm': 3
        };
        
        const DEFAULT_PRODUCTS = [
            // Cement
            { id: 1, name: 'Bangur Cement', category: 'cement', brand: 'Bangur', unit: 'bags', price: 350, unitWeight: '50kg' },
            { id: 2, name: 'Jung Rodhak Cement', category: 'cement', brand: 'Jung Rodhak', unit: 'bags', price: 340, unitWeight: '50kg' },
            { id: 3, name: 'JSW Cement', category: 'cement', brand: 'JSW', unit: 'bags', price: 360, unitWeight: '50kg' },
            { id: 4, name: 'JSW HD Cement', category: 'cement', brand: 'JSW HD', unit: 'bags', price: 370, unitWeight: '50kg' },
            { id: 5, name: 'Dalmia Cement', category: 'cement', brand: 'Dalmia', unit: 'bags', price: 355, unitWeight: '50kg' },
            
            // Steel Rods
            { id: 6, name: '6mm Rod', category: 'rods', brand: 'Magadh', unit: 'bundles', price: 4200, piecesPerBundle: 20 },
            { id: 7, name: '8mm Rod', category: 'rods', brand: 'Magadh', unit: 'bundles', price: 4200, piecesPerBundle: 12 },
            { id: 8, name: '10mm Rod', category: 'rods', brand: 'Magadh', unit: 'bundles', price: 4200, piecesPerBundle: 8 },
            { id: 9, name: '12mm Rod', category: 'rods', brand: 'Magadh', unit: 'bundles', price: 4200, piecesPerBundle: 5 },
            { id: 10, name: '16mm Rod', category: 'rods', brand: 'Magadh', unit: 'bundles', price: 4200, piecesPerBundle: 3 },
            
            // Sand & Stone
            { id: 11, name: 'Sand', category: 'sand', unit: 'trailers', price: 12000 },
            { id: 12, name: 'Sand (Half)', category: 'sand', unit: 'half-trailers', price: 6500 },
            { id: 13, name: 'Stone Chips', category: 'stone', unit: 'trailers', price: 11000 },
            { id: 14, name: 'Stone Chips (Half)', category: 'stone', unit: 'half-trailers', price: 6000 },
            
            // Chemicals
            { id: 15, name: 'Chemical Waterproofing', category: 'chemical', unit: 'liters', price: 250 },
            { id: 16, name: 'Concrete Bond', category: 'chemical', unit: 'liters', price: 300 },
            { id: 17, name: 'Tile Adhesive', category: 'chemical', unit: 'kg', price: 45 }
        ];
        
        let currentUser = null;
        let currentCustomerExcel = null;
        let currentReceiptData = null;
        let shoppingCart = [];
        
        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            currentUser = JSON.parse(localStorage.getItem(STORAGE_KEYS.CURRENT_USER));
            if (!currentUser) {
                window.location.href = 'index.html';
                return;
            }
            
            // Set date and user info
            document.getElementById('current-date').textContent = new Date().toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            document.getElementById('user-name').textContent = currentUser.name || 'Admin';
            
            // Initialize products if not exists
            initializeProducts();
            
            // Initialize date pickers
            flatpickr("#date-filter", { dateFormat: "Y-m-d" });
            flatpickr("#payment-date-filter", { dateFormat: "Y-m-d" });
            flatpickr("#report-start-date", { dateFormat: "Y-m-d" });
            flatpickr("#report-end-date", { dateFormat: "Y-m-d" });
            
            // Load data and setup
            loadDashboardData();
            setupEventListeners();
            setupMenuNavigation();
            
            // Update product options
            updateProductOptions();
            
            // Setup form listeners
            setupFormListeners();
        });
        
        function initializeProducts() {
            let products = JSON.parse(localStorage.getItem(STORAGE_KEYS.PRODUCTS));
            if (!products || products.length === 0) {
                localStorage.setItem(STORAGE_KEYS.PRODUCTS, JSON.stringify(DEFAULT_PRODUCTS));
            }
        }
        
        function setupEventListeners() {
            // Menu toggle
            document.getElementById('menu-toggle').addEventListener('click', function() {
                document.getElementById('mobile-sidebar').classList.remove('-translate-x-full');
            });
            
            document.getElementById('close-menu').addEventListener('click', function() {
                document.getElementById('mobile-sidebar').classList.add('-translate-x-full');
            });
            
            // Logout
            document.getElementById('logout-btn').addEventListener('click', function() {
                if (confirm('Are you sure you want to logout?')) {
                    localStorage.removeItem(STORAGE_KEYS.CURRENT_USER);
                    window.location.href = 'index.html';
                }
            });
            
            // Export buttons
            document.getElementById('export-excel-btn').addEventListener('click', exportMasterExcel);
            document.getElementById('export-customers-btn').addEventListener('click', exportCustomersExcel);
            document.getElementById('export-orders-btn').addEventListener('click', exportOrdersExcel);
            document.getElementById('export-payments-btn').addEventListener('click', exportPaymentsExcel);
            
            // Quick actions
            document.getElementById('quick-add-order').addEventListener('click', function() {
                showSection('dashboard');
                document.getElementById('customer-order-form').scrollIntoView({ behavior: 'smooth' });
                document.getElementById('customer-name').focus();
            });
            
            document.getElementById('quick-add-payment').addEventListener('click', function() {
                openPaymentModal();
            });
            
            document.getElementById('quick-search-customer').addEventListener('click', function() {
                openSearchModal();
            });
            
            // Add new product
            document.getElementById('add-new-product-btn').addEventListener('click', function() {
                openPriceModal();
            });
            
            // Payment modal
            document.getElementById('cancel-payment').addEventListener('click', function() {
                document.getElementById('payment-modal').classList.add('hidden');
            });
            
            document.getElementById('payment-form').addEventListener('submit', function(e) {
                e.preventDefault();
                savePayment();
            });
            
            // Price modal form
            document.getElementById('price-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveProductPrice();
            });
            
            // Search functionality
            document.getElementById('search-input').addEventListener('input', function(e) {
                searchCustomers(e.target.value);
            });
            
            document.getElementById('search-customer-input').addEventListener('input', function(e) {
                loadAllCustomers(e.target.value);
            });
            
            // Report filters
            document.getElementById('status-filter').addEventListener('change', function() {
                loadAllOrders();
            });
            
            document.getElementById('generate-report-btn').addEventListener('click', function() {
                generateReport();
            });
            
            // Cart event listeners
            document.getElementById('add-to-cart-btn').addEventListener('click', function(e) {
                e.preventDefault();
                addToCart();
            });
            
            document.getElementById('clear-cart-btn').addEventListener('click', clearCart);
            
            document.getElementById('checkout-btn').addEventListener('click', function(e) {
                e.preventDefault();
                proceedToCheckout();
            });
            
            // Checkout modal payment mode change
            document.getElementById('checkout-payment-mode').addEventListener('change', function() {
                const advanceContainer = document.getElementById('checkout-advance-container');
                if (this.value === 'partial') {
                    advanceContainer.classList.remove('hidden');
                } else {
                    advanceContainer.classList.add('hidden');
                }
            });
            
            // Form submission (for cart)
            document.getElementById('customer-order-form').addEventListener('submit', function(e) {
                e.preventDefault();
                addToCart();
            });
            
            // Close modals when clicking outside
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.add('hidden');
                    }
                });
            });
        }
        
        function setupFormListeners() {
            // Payment mode change
            document.getElementById('payment-mode').addEventListener('change', function() {
                const advanceContainer = document.getElementById('advance-container');
                if (this.value === 'partial') {
                    advanceContainer.classList.remove('hidden');
                } else {
                    advanceContainer.classList.add('hidden');
                }
            });
            
            // Quantity change - update amount
            document.getElementById('material-quantity').addEventListener('input', calculateAmount);
            document.getElementById('unit-select').addEventListener('change', calculateAmount);
            
            // Product select - update unit and price
            document.getElementById('product-select').addEventListener('change', function() {
                updateUnitAndPrice();
            });
        }
        
        function setupMenuNavigation() {
            // Desktop menu
            document.querySelectorAll('#menu-dashboard, #menu-customers, #menu-orders, #menu-payments, #menu-reports, #menu-prices').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = this.getAttribute('href').substring(1);
                    showSection(section);
                    
                    // Update active state
                    document.querySelectorAll('#menu-dashboard, #menu-customers, #menu-orders, #menu-payments, #menu-reports, #menu-prices').forEach(i => {
                        i.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // Close mobile menu
                    document.getElementById('mobile-sidebar').classList.add('-translate-x-full');
                });
            });
            
            // Mobile menu
            document.querySelectorAll('#mobile-sidebar .menu-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = this.getAttribute('href').substring(1);
                    showSection(section);
                    
                    // Update active state
                    document.querySelectorAll('#mobile-sidebar .menu-item').forEach(i => {
                        i.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // Close mobile menu
                    document.getElementById('mobile-sidebar').classList.add('-translate-x-full');
                });
            });
        }
        
        function showSection(section) {
            // Hide all sections
            document.getElementById('dashboard-content').classList.add('hidden');
            document.getElementById('customers-content').classList.add('hidden');
            document.getElementById('orders-content').classList.add('hidden');
            document.getElementById('payments-content').classList.add('hidden');
            document.getElementById('reports-content').classList.add('hidden');
            document.getElementById('prices-content').classList.add('hidden');
            
            // Show selected section
            document.getElementById(`${section}-content`).classList.remove('hidden');
            
            // Load data for the section
            switch(section) {
                case 'customers':
                    loadAllCustomers();
                    break;
                case 'orders':
                    loadAllOrders();
                    break;
                case 'payments':
                    loadAllPayments();
                    break;
                case 'reports':
                    loadReports();
                    break;
                case 'prices':
                    loadProductPrices();
                    break;
            }
        }
        
        // ==================== CART MANAGEMENT ====================
        function addToCart() {
            const productId = parseInt(document.getElementById('product-select').value);
            const quantity = parseFloat(document.getElementById('material-quantity').value) || 0;
            const unit = document.getElementById('unit-select').value;
            const unitPrice = parseFloat(document.getElementById('unit-price').value) || 0;
            const itemTotal = parseFloat(document.getElementById('order-amount').value) || 0;
            
            if (!productId || quantity <= 0 || unitPrice <= 0) {
                showToast('Please select a product and enter valid quantity', 'error');
                return;
            }
            
            // Get product details
            const products = getProducts();
            const product = products.find(p => p.id === productId);
            
            if (!product) {
                showToast('Product not found', 'error');
                return;
            }
            
            // Check if product already in cart
            const existingIndex = shoppingCart.findIndex(item => item.productId === productId && item.unit === unit);
            
            if (existingIndex > -1) {
                // Update existing item
                shoppingCart[existingIndex].quantity += quantity;
                shoppingCart[existingIndex].itemTotal = shoppingCart[existingIndex].quantity * unitPrice;
                showToast('Product quantity updated in cart');
            } else {
                // Add new item
                const cartItem = {
                    id: Date.now(),
                    productId: productId,
                    productName: product.name,
                    productCategory: product.category,
                    productBrand: product.brand || '',
                    quantity: quantity,
                    unit: unit,
                    unitPrice: unitPrice,
                    itemTotal: itemTotal,
                    unitWeight: product.unitWeight || '',
                    piecesPerBundle: product.piecesPerBundle || null
                };
                
                shoppingCart.push(cartItem);
                showToast('Product added to cart');
            }
            
            // Update cart display
            updateCartDisplay();
            
            // Reset form for next item
            document.getElementById('material-quantity').value = '1';
            document.getElementById('unit-price').value = '';
            document.getElementById('order-amount').value = '';
            
            // Scroll to cart
            document.getElementById('cart-items').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        function updateCartDisplay() {
            const cartEmpty = document.getElementById('cart-empty');
            const cartItems = document.getElementById('cart-items');
            const cartTable = document.getElementById('cart-items-table');
            const cartSummary = document.getElementById('cart-summary');
            const cartTotalDisplay = document.getElementById('cart-total-display');
            
            if (shoppingCart.length === 0) {
                cartEmpty.classList.remove('hidden');
                cartItems.classList.add('hidden');
                cartTotalDisplay.textContent = 'Cart Total: ₹0';
                return;
            }
            
            cartEmpty.classList.add('hidden');
            cartItems.classList.remove('hidden');
            
            // Clear existing rows
            cartTable.innerHTML = '';
            
            let subtotal = 0;
            
            // Add cart items
            shoppingCart.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = 'table-row fade-in';
                
                row.innerHTML = `
                    <td class="py-3 px-4">
                        <div class="font-medium text-gray-800">${item.productName}</div>
                        <div class="text-sm text-gray-600">${item.productBrand}</div>
                    </td>
                    <td class="py-3 px-4 capitalize">${item.productCategory}</td>
                    <td class="py-3 px-4">${item.quantity} ${item.unit}</td>
                    <td class="py-3 px-4">₹${item.unitPrice}</td>
                    <td class="py-3 px-4 font-medium">₹${item.itemTotal.toFixed(2)}</td>
                    <td class="py-3 px-4">
                        <button onclick="updateCartItem(${index})" class="text-blue-600 hover:text-blue-800 mr-2" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="removeFromCart(${index})" class="text-red-600 hover:text-red-800" title="Remove">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                cartTable.appendChild(row);
                subtotal += item.itemTotal;
            });
            
            // Update summary
            const total = subtotal;
            cartSummary.innerHTML = `
                <tr>
                    <td colspan="4" class="py-3 px-4 text-right font-medium">Subtotal:</td>
                    <td class="py-3 px-4 font-bold text-lg">₹${total.toFixed(2)}</td>
                    <td class="py-3 px-4"></td>
                </tr>
            `;
            
            cartTotalDisplay.textContent = `Cart Total: ₹${total.toFixed(2)}`;
        }
        
        function removeFromCart(index) {
            if (index >= 0 && index < shoppingCart.length) {
                const removedItem = shoppingCart[index];
                shoppingCart.splice(index, 1);
                updateCartDisplay();
                showToast(`Removed ${removedItem.productName} from cart`);
            }
        }
        
        function updateCartItem(index) {
            if (index >= 0 && index < shoppingCart.length) {
                const item = shoppingCart[index];
                
                // Load item into form
                document.getElementById('category-select').value = item.productCategory;
                updateProductOptions();
                
                // Wait for product options to update
                setTimeout(() => {
                    document.getElementById('product-select').value = item.productId;
                    updateUnitAndPrice();
                    
                    // Set quantity and unit
                    document.getElementById('material-quantity').value = item.quantity;
                    document.getElementById('unit-select').value = item.unit;
                    
                    // Remove from cart
                    shoppingCart.splice(index, 1);
                    updateCartDisplay();
                    
                    showToast('Item loaded for editing');
                }, 100);
            }
        }
        
        function clearCart() {
            if (shoppingCart.length === 0) return;
            
            if (confirm('Are you sure you want to clear all items from the cart?')) {
                shoppingCart = [];
                updateCartDisplay();
                showToast('Cart cleared');
            }
        }
        
        function proceedToCheckout() {
            // Validate customer details
            const customerName = document.getElementById('customer-name').value.trim();
            const customerPhone = document.getElementById('customer-phone').value.trim();
            
            if (!customerName || !customerPhone) {
                showToast('Please enter customer details before checkout', 'error');
                document.getElementById('customer-name').focus();
                return;
            }
            
            if (shoppingCart.length === 0) {
                showToast('Please add items to cart before checkout', 'error');
                return;
            }
            
            // Calculate totals
            let subtotal = 0;
            shoppingCart.forEach(item => {
                subtotal += item.itemTotal;
            });
            
            // Update checkout modal
            document.getElementById('checkout-customer-name').textContent = customerName;
            document.getElementById('checkout-customer-phone').textContent = customerPhone;
            document.getElementById('checkout-customer-address').textContent = document.getElementById('customer-address').value || 'Not provided';
            document.getElementById('checkout-subtotal').textContent = subtotal.toFixed(2);
            document.getElementById('checkout-total').textContent = subtotal.toFixed(2);
            
            // Update checkout items table
            const checkoutTable = document.getElementById('checkout-items-table');
            checkoutTable.innerHTML = '';
            
            shoppingCart.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'border-t';
                row.innerHTML = `
                    <td class="py-2 px-3">${item.productName}</td>
                    <td class="py-2 px-3">${item.quantity} ${item.unit}</td>
                    <td class="py-2 px-3">₹${item.itemTotal.toFixed(2)}</td>
                `;
                checkoutTable.appendChild(row);
            });
            
            // Show checkout modal
            document.getElementById('checkout-modal').classList.remove('hidden');
        }
        
        function closeCheckoutModal() {
            document.getElementById('checkout-modal').classList.add('hidden');
        }
        
        function completeCheckout() {
            const customerName = document.getElementById('customer-name').value.trim();
            const customerPhone = document.getElementById('customer-phone').value.trim();
            const customerAddress = document.getElementById('customer-address').value.trim();
            const paymentMode = document.getElementById('checkout-payment-mode').value;
            const advanceAmount = paymentMode === 'partial' ? parseFloat(document.getElementById('checkout-advance-amount').value) || 0 : 0;
            const notes = document.getElementById('checkout-notes').value.trim();
            
            // Validation
            if (!customerName || !customerPhone) {
                showToast('Customer details are required', 'error');
                return;
            }
            
            if (shoppingCart.length === 0) {
                showToast('No items in cart', 'error');
                return;
            }
            
            // Calculate totals
            let totalAmount = 0;
            shoppingCart.forEach(item => {
                totalAmount += item.itemTotal;
            });
            
            // Check if customer exists
            let customers = getCustomers();
            let customer = customers.find(c => c.phone === customerPhone);
            let customerId;
            
            if (customer) {
                // Update existing customer
                customerId = customer.id;
                customer.name = customerName;
                customer.address = customerAddress || customer.address;
                customer.totalOrders = (customer.totalOrders || 0) + 1;
                customer.totalAmount = (customer.totalAmount || 0) + totalAmount;
                customer.totalPaid = (customer.totalPaid || 0) + (paymentMode === 'cash' ? totalAmount : (paymentMode === 'partial' ? advanceAmount : 0));
                customer.balance = (customer.balance || 0) + (paymentMode === 'credit' ? totalAmount : (paymentMode === 'partial' ? (totalAmount - advanceAmount) : 0));
                customer.lastPurchaseDate = new Date().toISOString();
                customer.updatedAt = new Date().toISOString();
            } else {
                // Create new customer
                customerId = Date.now();
                customer = {
                    id: customerId,
                    name: customerName,
                    phone: customerPhone,
                    address: customerAddress,
                    totalOrders: 1,
                    totalAmount: totalAmount,
                    totalPaid: paymentMode === 'cash' ? totalAmount : (paymentMode === 'partial' ? advanceAmount : 0),
                    balance: paymentMode === 'credit' ? totalAmount : (paymentMode === 'partial' ? (totalAmount - advanceAmount) : 0),
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    lastPurchaseDate: new Date().toISOString()
                };
                customers.push(customer);
            }
            
            // Save customer
            localStorage.setItem(STORAGE_KEYS.CUSTOMERS, JSON.stringify(customers));
            
            // Create orders for each cart item
            const masterOrderId = Date.now();
            const orders = [];
            
            shoppingCart.forEach((item, index) => {
                const orderId = masterOrderId + index;
                const order = {
                    id: orderId,
                    customerId: customerId,
                    customerName: customerName,
                    customerPhone: customerPhone,
                    productId: item.productId,
                    productName: item.productName,
                    productCategory: item.productCategory,
                    productBrand: item.productBrand,
                    quantity: item.quantity,
                    unit: item.unit,
                    unitPrice: item.unitPrice,
                    amount: item.itemTotal,
                    paymentMode: paymentMode,
                    advanceAmount: advanceAmount * (item.itemTotal / totalAmount), // Proportional advance
                    balance: paymentMode === 'credit' ? item.itemTotal : 
                             (paymentMode === 'partial' ? (item.itemTotal - (advanceAmount * (item.itemTotal / totalAmount))) : 0),
                    notes: notes,
                    date: new Date().toISOString().split('T')[0],
                    timestamp: new Date().toISOString(),
                    status: paymentMode === 'credit' ? 'pending' : (paymentMode === 'partial' ? 'partial' : 'paid'),
                    cartOrder: true,
                    masterOrderId: masterOrderId
                };
                
                orders.push(order);
            });
            
            // Save orders
            let allOrders = getOrders();
            orders.forEach(order => {
                allOrders.push(order);
            });
            localStorage.setItem(STORAGE_KEYS.ORDERS, JSON.stringify(allOrders));
            
            // Record payment if cash or partial
            if (paymentMode === 'cash' || paymentMode === 'partial') {
                const paymentAmount = paymentMode === 'partial' ? advanceAmount : totalAmount;
                const paymentId = Date.now() + shoppingCart.length + 1;
                const payment = {
                    id: paymentId,
                    customerId: customerId,
                    customerName: customerName,
                    customerPhone: customerPhone,
                    orderIds: orders.map(o => o.id),
                    amount: paymentAmount,
                    paymentMode: 'cash',
                    reference: `Cart Order #${masterOrderId}`,
                    type: paymentMode === 'partial' ? 'advance' : 'full',
                    date: new Date().toISOString().split('T')[0],
                    timestamp: new Date().toISOString()
                };
                
                let payments = getPayments();
                payments.push(payment);
                localStorage.setItem(STORAGE_KEYS.PAYMENTS, JSON.stringify(payments));
                
                // Update daily report payments
                updateDailyReportWithPayment(payment);
            }
            
            // Update daily reports for each order
            orders.forEach(order => {
                updateDailyReport(order);
            });
            
            // Save to customer's individual Excel record
            saveCartToCustomerExcel(customer, orders, totalAmount);
            
            // Generate combined receipt
            generateCartReceipt(customer, orders, totalAmount, paymentMode, advanceAmount);
            
            // Clear cart and reset form
            shoppingCart = [];
            updateCartDisplay();
            document.getElementById('customer-order-form').reset();
            document.getElementById('category-select').value = '';
            document.getElementById('product-select').innerHTML = '<option value="">Select Product</option>';
            
            // Close checkout modal
            closeCheckoutModal();
            
            // Show success animation
            playSuccessAnimation('customer');
            
            // Reload dashboard
            loadDashboardData();
            
            showToast('Order completed successfully!');
        }
        
        function saveCartToCustomerExcel(customer, orders, totalAmount) {
            let customerExcel = JSON.parse(localStorage.getItem(STORAGE_KEYS.CUSTOMER_EXCEL)) || {};
            
            if (!customerExcel[customer.id]) {
                customerExcel[customer.id] = {
                    customerInfo: {
                        id: customer.id,
                        name: customer.name,
                        phone: customer.phone,
                        address: customer.address,
                        joinDate: customer.createdAt
                    },
                    orders: [],
                    payments: []
                };
            }
            
            // Add all orders
            orders.forEach(order => {
                customerExcel[customer.id].orders.push({
                    orderId: order.id,
                    date: order.date,
                    time: new Date(order.timestamp).toLocaleTimeString(),
                    productName: order.productName,
                    quantity: order.quantity,
                    unit: order.unit,
                    amount: order.amount,
                    paymentMode: order.paymentMode,
                    advanceAmount: order.advanceAmount,
                    balance: order.balance,
                    notes: order.notes,
                    cartOrder: true
                });
            });
            
            localStorage.setItem(STORAGE_KEYS.CUSTOMER_EXCEL, JSON.stringify(customerExcel));
        }
        
        function generateCartReceipt(customer, orders, totalAmount, paymentMode, advanceAmount) {
            const date = new Date().toISOString().split('T')[0];
            const time = new Date().toLocaleTimeString();
            const receiptNo = 'CART-' + Date.now().toString().slice(-6);
            
            // Build receipt content
            let receiptHTML = `
                <div class="text-center mb-4">
                    <h2 class="text-2xl font-bold">NAMAN ENTERPRISES</h2>
                    <p class="text-gray-600">Building Materials Supplier</p>
                    <p class="text-sm">Receipt No: ${receiptNo}</p>
                </div>
                
                <div class="border-t border-b border-gray-300 py-3 my-3">
                    <div class="flex justify-between mb-2">
                        <span class="font-semibold">Date:</span>
                        <span>${date}</span>
                    </div>
                    <div class="flex justify-between mb-2">
                        <span class="font-semibold">Time:</span>
                        <span>${time}</span>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h3 class="font-bold text-lg mb-2">Customer Details</h3>
                    <p><strong>Name:</strong> ${customer.name}</p>
                    <p><strong>Phone:</strong> ${customer.phone}</p>
                    ${customer.address ? `<p><strong>Address:</strong> ${customer.address}</p>` : ''}
                </div>
                
                <div class="border-t border-b border-gray-300 py-3 my-3">
                    <h3 class="font-bold text-lg mb-2">Order Summary</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="py-2 px-3 text-left">Product</th>
                                    <th class="py-2 px-3 text-left">Qty</th>
                                    <th class="py-2 px-3 text-left">Unit Price</th>
                                    <th class="py-2 px-3 text-left">Total</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            orders.forEach(order => {
                receiptHTML += `
                    <tr class="border-t">
                        <td class="py-2 px-3">${order.productName}</td>
                        <td class="py-2 px-3">${order.quantity} ${order.unit}</td>
                        <td class="py-2 px-3">₹${order.unitPrice}</td>
                        <td class="py-2 px-3">₹${order.amount}</td>
                    </tr>
                `;
            });
            
            receiptHTML += `
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t border-gray-300">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-medium">Payment Mode:</span>
                            <span class="uppercase">${paymentMode}</span>
                        </div>
            `;
            
            if (paymentMode === 'partial') {
                receiptHTML += `
                        <div class="flex justify-between items-center mb-2">
                            <span>Advance Paid:</span>
                            <span>₹${advanceAmount}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span>Balance Due:</span>
                            <span class="font-bold">₹${totalAmount - advanceAmount}</span>
                        </div>
                `;
            }
            
            receiptHTML += `
                        <div class="flex justify-between items-center text-xl font-bold mt-4">
                            <span>Total Amount:</span>
                            <span>₹${totalAmount}</span>
                        </div>
                    </div>
                </div>
                
                <div class="border-t border-gray-300 pt-4 mt-6 text-center text-sm text-gray-500">
                    <p>Thank you for your business!</p>
                    <p>For any queries, contact: ${document.getElementById('user-name').textContent}</p>
                </div>
            `;
            
            // Set receipt content
            currentReceiptData = {
                customerName: customer.name,
                customerPhone: customer.phone,
                customerAddress: customer.address,
                products: orders.map(o => ({
                    name: o.productName,
                    quantity: o.quantity,
                    unit: o.unit,
                    unitPrice: o.unitPrice,
                    amount: o.amount
                })),
                totalAmount: totalAmount,
                paymentMode: paymentMode,
                advanceAmount: advanceAmount,
                date: date,
                time: time,
                receiptNo: receiptNo,
                notes: orders[0]?.notes || ''
            };
            
            document.getElementById('receipt-content').innerHTML = receiptHTML;
            document.getElementById('receipt-modal').classList.remove('hidden');
        }
        
        // ==================== BACKUP & RESTORE FUNCTIONS ====================
        function backupAllData() {
            try {
                const backup = {
                    customers: getCustomers(),
                    orders: getOrders(),
                    payments: getPayments(),
                    products: getProducts(),
                    dailyReports: getDailyReports(),
                    timestamp: new Date().toISOString(),
                    version: 'v4',
                    totalRecords: {
                        customers: getCustomers().length,
                        orders: getOrders().length,
                        payments: getPayments().length,
                        products: getProducts().length,
                        dailyReports: getDailyReports().length
                    }
                };
                
                const dataStr = JSON.stringify(backup, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const today = new Date();
                const dateStr = today.toISOString().split('T')[0];
                const timeStr = today.getHours().toString().padStart(2, '0') + 
                               today.getMinutes().toString().padStart(2, '0');
                
                const exportFileDefaultName = `Naman_Enterprises_Backup_${dateStr}_${timeStr}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                showToast(`Backup created successfully! File: ${exportFileDefaultName}`);
                
            } catch (error) {
                showToast('Error creating backup: ' + error.message, 'error');
            }
        }
        
        function restoreFromBackup(file) {
            if (!confirm('⚠️ WARNING: This will overwrite ALL current data. Are you sure?')) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    
                    // Validate backup structure
                    if (!backup.customers || !backup.orders || !backup.payments || !backup.products) {
                        throw new Error('Invalid backup file format');
                    }
                    
                    // Validate version
                    if (!backup.version || !backup.version.startsWith('v')) {
                        if (!confirm('This backup file appears to be from an older version. Restore anyway?')) return;
                    }
                    
                    // Restore data
                    localStorage.setItem(STORAGE_KEYS.CUSTOMERS, JSON.stringify(backup.customers));
                    localStorage.setItem(STORAGE_KEYS.ORDERS, JSON.stringify(backup.orders));
                    localStorage.setItem(STORAGE_KEYS.PAYMENTS, JSON.stringify(backup.payments));
                    localStorage.setItem(STORAGE_KEYS.PRODUCTS, JSON.stringify(backup.products));
                    localStorage.setItem(STORAGE_KEYS.DAILY_REPORTS, JSON.stringify(backup.dailyReports || []));
                    
                    // Reload everything
                    setTimeout(() => {
                        loadDashboardData();
                        showToast(`Data restored successfully! Backup from ${backup.timestamp ? new Date(backup.timestamp).toLocaleString() : 'unknown date'}. Please refresh the page.`);
                    }, 500);
                    
                } catch (error) {
                    showToast('Error restoring backup: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        }
        
        // ==================== DATA MANAGEMENT ====================
        function loadDashboardData() {
            const customers = getCustomers();
            const orders = getOrders();
            const payments = getPayments();
            
            // Update stats
            updateStats(customers, orders, payments);
            
            // Load today's orders
            loadTodaysOrders(orders);
        }
        
        function updateStats(customers, orders, payments) {
            const today = new Date().toISOString().split('T')[0];
            
            let totalCustomers = customers.length;
            let totalRevenue = orders.reduce((sum, order) => sum + (parseFloat(order.amount) || 0), 0);
            let todaySales = orders.filter(order => 
                order.date && order.date === today
            ).reduce((sum, order) => sum + (parseFloat(order.amount) || 0), 0);
            
            let pendingPayments = customers.reduce((sum, customer) => {
                return sum + (parseFloat(customer.balance) || 0);
            }, 0);
            
            // Update UI
            document.getElementById('total-customers').textContent = totalCustomers;
            document.getElementById('total-revenue').textContent = '₹' + totalRevenue.toLocaleString();
            document.getElementById('today-sales').textContent = '₹' + todaySales.toLocaleString();
            document.getElementById('pending-payments').textContent = '₹' + pendingPayments.toLocaleString();
        }
        
        function loadTodaysOrders(orders) {
            const container = document.getElementById('todays-orders-table');
            const today = new Date().toISOString().split('T')[0];
            
            const todaysOrders = orders.filter(order => order.date === today);
            
            if (todaysOrders.length === 0) {
                container.innerHTML = `
                    <tr>
                        <td colspan="5" class="py-8 text-center text-gray-500">
                            <i class="fas fa-shopping-cart text-3xl mb-2 block mx-auto"></i>
                            <p>No orders today</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            container.innerHTML = '';
            todaysOrders.forEach(order => {
                const row = document.createElement('tr');
                row.className = 'table-row';
                
                let statusText = '';
                let statusColor = '';
                if (order.balance <= 0) {
                    statusText = 'Paid';
                    statusColor = 'bg-green-100 text-green-800';
                } else if (order.paymentMode === 'partial') {
                    statusText = 'Partial';
                    statusColor = 'bg-yellow-100 text-yellow-800';
                } else {
                    statusText = 'Pending';
                    statusColor = 'bg-red-100 text-red-800';
                }
                
                row.innerHTML = `
                    <td class="py-3 px-4">
                        <div class="font-medium text-gray-800">${order.customerName}</div>
                        <div class="text-sm text-gray-600">${order.customerPhone}</div>
                    </td>
                    <td class="py-3 px-4">${order.productName}</td>
                    <td class="py-3 px-4 font-medium">₹${order.amount || 0}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 text-xs rounded-full ${statusColor}">
                            ${statusText}
                        </span>
                    </td>
                    <td class="py-3 px-4 text-sm text-gray-600">
                        ${new Date(order.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                    </td>
                `;
                container.appendChild(row);
            });
        }
        
        // ==================== CUSTOMER MANAGEMENT ====================
        function loadAllCustomers(searchTerm = '') {
            const customers = getCustomers();
            const container = document.getElementById('all-customers-table');
            
            let filteredCustomers = customers;
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filteredCustomers = customers.filter(c => 
                    c.name.toLowerCase().includes(term) || 
                    c.phone.includes(term) ||
                    c.address.toLowerCase().includes(term)
                );
            }
            
            if (filteredCustomers.length === 0) {
                container.innerHTML = `
                    <tr>
                        <td colspan="8" class="py-8 text-center text-gray-500">
                            <i class="fas fa-users text-3xl mb-2 block mx-auto"></i>
                            <p>No customers found</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            container.innerHTML = '';
            filteredCustomers.forEach(customer => {
                const row = document.createElement('tr');
                row.className = 'table-row fade-in';
                
                row.innerHTML = `
                    <td class="py-3 px-4">CUST${customer.id.toString().padStart(4, '0')}</td>
                    <td class="py-3 px-4 font-medium text-gray-800">${customer.name}</td>
                    <td class="py-3 px-4">${customer.phone}</td>
                    <td class="py-3 px-4 text-sm">${customer.address || '-'}</td>
                    <td class="py-3 px-4 text-center">${customer.totalOrders || 0}</td>
                    <td class="py-3 px-4">₹${customer.totalAmount || 0}</td>
                    <td class="py-3 px-4 font-medium ${customer.balance > 0 ? 'text-red-600' : 'text-green-600'}">
                        ₹${customer.balance || 0}
                    </td>
                    <td class="py-3 px-4">
                        <button onclick="viewCustomerDetails(${customer.id})" class="text-blue-600 hover:text-blue-800 mr-3" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button onclick="exportCustomerExcel(${customer.id})" class="text-green-600 hover:text-green-800 mr-3" title="Export Excel">
                            <i class="fas fa-file-excel"></i>
                        </button>
                        <button onclick="deleteCustomer(${customer.id})" class="text-red-600 hover:text-red-800" title="Delete Customer">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                container.appendChild(row);
            });
        }
        
        function deleteCustomer(customerId) {
            if (!confirm('Are you sure you want to delete this customer and all associated data? This action cannot be undone.')) return;
            
            // Get customer data first for notification
            const customer = getCustomer(customerId);
            if (!customer) {
                showToast('Customer not found', 'error');
                return;
            }
            
            // 1. Delete customer from customers list
            let customers = getCustomers();
            customers = customers.filter(c => c.id !== customerId);
            localStorage.setItem(STORAGE_KEYS.CUSTOMERS, JSON.stringify(customers));
            
            // 2. Delete associated orders
            let orders = getOrders();
            const ordersToDelete = orders.filter(o => o.customerId === customerId);
            orders = orders.filter(o => o.customerId !== customerId);
            localStorage.setItem(STORAGE_KEYS.ORDERS, JSON.stringify(orders));
            
            // 3. Delete associated payments
            let payments = getPayments();
            payments = payments.filter(p => p.customerId !== customerId);
            localStorage.setItem(STORAGE_KEYS.PAYMENTS, JSON.stringify(payments));
            
            // 4. Delete from daily reports (update counts)
            updateDailyReportsAfterCustomerDelete(customerId, ordersToDelete);
            
            // 5. Delete from customer Excel records
            deleteCustomerExcelData(customerId);
            
            // Show success animation
            playDeleteAnimation();
            
            // Reload data
            loadDashboardData();
            loadAllCustomers();
            
            showToast(`Customer "${customer.name}" deleted successfully`);
        }
        
        function updateDailyReportsAfterCustomerDelete(customerId, deletedOrders) {
            let reports = getDailyReports();
            
            // Update each report that might have been affected
            reports.forEach(report => {
                // Count orders for this date that were deleted
                const ordersForDate = deletedOrders.filter(o => o.date === report.date);
                if (ordersForDate.length > 0) {
                    report.totalOrders = Math.max(0, (report.totalOrders || 0) - ordersForDate.length);
                    report.totalAmount = Math.max(0, (report.totalAmount || 0) - 
                        ordersForDate.reduce((sum, o) => sum + o.amount, 0));
                    
                    // Check if this customer was created on this date
                    const customer = getCustomer(customerId);
                    if (customer && customer.createdAt && customer.createdAt.split('T')[0] === report.date) {
                        report.newCustomers = Math.max(0, (report.newCustomers || 0) - 1);
                    }
                }
            });
            
            localStorage.setItem(STORAGE_KEYS.DAILY_REPORTS, JSON.stringify(reports));
        }
        
        function deleteCustomerExcelData(customerId) {
            let customerExcel = JSON.parse(localStorage.getItem(STORAGE_KEYS.CUSTOMER_EXCEL)) || {};
            delete customerExcel[customerId];
            localStorage.setItem(STORAGE_KEYS.CUSTOMER_EXCEL, JSON.stringify(customerExcel));
        }
        
        function viewCustomerDetails(customerId) {
            const customer = getCustomer(customerId);
            const orders = getOrders().filter(o => o.customerId === customerId);
            const payments = getPayments().filter(p => p.customerId === customerId);
            
            // Create modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 modal-overlay flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-4xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800">Customer Details</h3>
                            <p class="text-gray-600">CUST${customer.id.toString().padStart(4, '0')}</p>
                        </div>
                        <button onclick="this.closest('.modal-overlay').remove()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-gray-700 mb-3">Customer Information</h4>
                            <div class="space-y-2">
                                <div><strong>Name:</strong> ${customer.name}</div>
                                <div><strong>Phone:</strong> ${customer.phone}</div>
                                <div><strong>Address:</strong> ${customer.address || 'Not provided'}</div>
                                <div><strong>Member Since:</strong> ${new Date(customer.createdAt).toLocaleDateString()}</div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-gray-700 mb-3">Financial Summary</h4>
                            <div class="space-y-2">
                                <div><strong>Total Orders:</strong> ${customer.totalOrders || 0}</div>
                                <div><strong>Total Amount:</strong> ₹${customer.totalAmount || 0}</div>
                                <div><strong>Total Paid:</strong> ₹${customer.totalPaid || 0}</div>
                                <div><strong>Balance:</strong> ₹${customer.balance || 0}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h4 class="font-semibold text-gray-700 mb-3">Order History</h4>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="py-2 px-3 text-left text-sm">Date</th>
                                        <th class="py-2 px-3 text-left text-sm">Product</th>
                                        <th class="py-2 px-3 text-left text-sm">Quantity</th>
                                        <th class="py-2 px-3 text-left text-sm">Amount</th>
                                        <th class="py-2 px-3 text-left text-sm">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${orders.map(order => `
                                        <tr class="border-t">
                                            <td class="py-2 px-3">${new Date(order.timestamp).toLocaleDateString()}</td>
                                            <td class="py-2 px-3">${order.productName}</td>
                                            <td class="py-2 px-3">${order.quantity} ${order.unit}</td>
                                            <td class="py-2 px-3">₹${order.amount}</td>
                                            <td class="py-2 px-3">
                                                <span class="px-2 py-1 text-xs rounded-full ${order.balance > 0 ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                                                    ${order.balance > 0 ? 'Pending' : 'Paid'}
                                                </span>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    document.body.removeChild(this);
                }
            });
            
            document.body.appendChild(modal);
        }
        
        // ==================== ORDER MANAGEMENT ====================
        function loadAllOrders() {
            const orders = getOrders();
            const filterStatus = document.getElementById('status-filter').value;
            
            let filteredOrders = orders;
            if (filterStatus) {
                if (filterStatus === 'paid') {
                    filteredOrders = orders.filter(o => o.balance <= 0);
                } else if (filterStatus === 'pending') {
                    filteredOrders = orders.filter(o => o.balance > 0 && o.paymentMode === 'credit');
                } else if (filterStatus === 'partial') {
                    filteredOrders = orders.filter(o => o.paymentMode === 'partial');
                }
            }
            
            const container = document.getElementById('all-orders-table');
            
            if (filteredOrders.length === 0) {
                container.innerHTML = `
                    <tr>
                        <td colspan="9" class="py-8 text-center text-gray-500">
                            <i class="fas fa-shopping-cart text-3xl mb-2 block mx-auto"></i>
                            <p>No orders found</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            container.innerHTML = '';
            filteredOrders.forEach(order => {
                const row = document.createElement('tr');
                row.className = 'table-row fade-in';
                
                let statusText = '';
                let statusColor = '';
                if (order.balance <= 0) {
                    statusText = 'Paid';
                    statusColor = 'bg-green-100 text-green-800';
                } else if (order.paymentMode === 'partial') {
                    statusText = 'Partial';
                    statusColor = 'bg-yellow-100 text-yellow-800';
                } else {
                    statusText = 'Pending';
                    statusColor = 'bg-red-100 text-red-800';
                }
                
                row.innerHTML = `
                    <td class="py-3 px-4">ORD${order.id.toString().padStart(4, '0')}</td>
                    <td class="py-3 px-4">
                        <div class="font-medium text-gray-800">${order.customerName}</div>
                        <div class="text-sm text-gray-600">${order.customerPhone}</div>
                    </td>
                    <td class="py-3 px-4">${order.productName}</td>
                    <td class="py-3 px-4">${order.quantity} ${order.unit}</td>
                    <td class="py-3 px-4 font-medium">₹${order.amount}</td>
                    <td class="py-3 px-4 capitalize">${order.paymentMode}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 text-xs rounded-full ${statusColor}">
                            ${statusText}
                        </span>
                    </td>
                    <td class="py-3 px-4 text-sm">${new Date(order.timestamp).toLocaleDateString()}</td>
                    <td class="py-3 px-4">
                        <button onclick="viewOrderReceipt(${order.id})" class="text-blue-600 hover:text-blue-800 mr-2" title="View Receipt">
                            <i class="fas fa-receipt"></i>
                        </button>
                        <button onclick="deleteOrder(${order.id})" class="text-red-600 hover:text-red-800" title="Delete Order">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                container.appendChild(row);
            });
        }
        
        // ==================== PAYMENT MANAGEMENT ====================
        function loadAllPayments() {
            const payments = getPayments();
            const container = document.getElementById('all-payments-table');
            
            if (payments.length === 0) {
                container.innerHTML = `
                    <tr>
                        <td colspan="7" class="py-8 text-center text-gray-500">
                            <i class="fas fa-rupee-sign text-3xl mb-2 block mx-auto"></i>
                            <p>No payments found</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            container.innerHTML = '';
            payments.forEach(payment => {
                const row = document.createElement('tr');
                row.className = 'table-row fade-in';
                
                row.innerHTML = `
                    <td class="py-3 px-4">PAY${payment.id.toString().padStart(4, '0')}</td>
                    <td class="py-3 px-4">
                        <div class="font-medium text-gray-800">${payment.customerName}</div>
                        <div class="text-sm text-gray-600">${payment.customerPhone}</div>
                    </td>
                    <td class="py-3 px-4 font-medium">₹${payment.amount}</td>
                    <td class="py-3 px-4 capitalize">${payment.paymentMode}</td>
                    <td class="py-3 px-4 text-sm">${payment.reference || '-'}</td>
                    <td class="py-3 px-4 text-sm">${new Date(payment.timestamp).toLocaleDateString()}</td>
                    <td class="py-3 px-4">
                        <button onclick="deletePayment(${payment.id})" class="text-red-600 hover:text-red-800" title="Delete Payment">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                container.appendChild(row);
            });
        }
        
        // ==================== PRODUCT PRICE MANAGEMENT ====================
        function loadProductPrices() {
            const products = getProducts();
            
            // Group products by category
            const cementProducts = products.filter(p => p.category === 'cement');
            const rodProducts = products.filter(p => p.category === 'rods');
            const sandProducts = products.filter(p => p.category === 'sand');
            const stoneProducts = products.filter(p => p.category === 'stone');
            const chemicalProducts = products.filter(p => p.category === 'chemical');
            
            // Render cement prices
            const cementContainer = document.getElementById('cement-prices');
            cementContainer.innerHTML = cementProducts.map(product => `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg slide-up">
                    <div>
                        <div class="font-medium">${product.name}</div>
                        <div class="text-sm text-gray-600">${product.brand || ''} • ${product.unitWeight || ''}</div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <span class="font-bold text-lg">₹${product.price}</span>
                        <button onclick="editProductPrice(${product.id})" class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            
            // Render rod prices
            const rodContainer = document.getElementById('rod-prices');
            rodContainer.innerHTML = rodProducts.map(product => `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg slide-up">
                    <div>
                        <div class="font-medium">${product.name}</div>
                        <div class="text-sm text-gray-600">${product.brand || ''} • ${product.piecesPerBundle || 0} pcs/bundle</div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <span class="font-bold text-lg">₹${product.price}</span>
                        <button onclick="editProductPrice(${product.id})" class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            
            // Render sand & stone prices
            const sandStoneContainer = document.getElementById('sand-stone-prices');
            sandStoneContainer.innerHTML = [...sandProducts, ...stoneProducts].map(product => `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg slide-up">
                    <div>
                        <div class="font-medium">${product.name}</div>
                        <div class="text-sm text-gray-600">Per ${product.unit}</div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <span class="font-bold text-lg">₹${product.price}</span>
                        <button onclick="editProductPrice(${product.id})" class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            
            // Render chemical prices
            const chemicalContainer = document.getElementById('chemical-prices');
            chemicalContainer.innerHTML = chemicalProducts.map(product => `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg slide-up">
                    <div>
                        <div class="font-medium">${product.name}</div>
                        <div class="text-sm text-gray-600">Per ${product.unit}</div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <span class="font-bold text-lg">₹${product.price}</span>
                        <button onclick="editProductPrice(${product.id})" class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        function editProductPrice(productId) {
            const products = getProducts();
            const product = products.find(p => p.id === productId);
            
            if (!product) return;
            
            document.getElementById('price-modal-title').textContent = 'Edit Product Price';
            document.getElementById('edit-product-id').value = product.id;
            document.getElementById('edit-product-name').value = product.name;
            document.getElementById('edit-product-category').value = product.category;
            document.getElementById('edit-product-brand').value = product.brand || '';
            document.getElementById('edit-product-unit').value = product.unit;
            document.getElementById('edit-product-price').value = product.price;
            document.getElementById('edit-product-desc').value = product.description || '';
            
            document.getElementById('price-modal').classList.remove('hidden');
        }
        
        function openPriceModal() {
            document.getElementById('price-modal-title').textContent = 'Add New Product';
            document.getElementById('price-form').reset();
            document.getElementById('edit-product-id').value = '';
            document.getElementById('price-modal').classList.remove('hidden');
        }
        
        function closePriceModal() {
            document.getElementById('price-modal').classList.add('hidden');
        }
        
        function saveProductPrice() {
            const id = document.getElementById('edit-product-id').value;
            const name = document.getElementById('edit-product-name').value.trim();
            const category = document.getElementById('edit-product-category').value;
            const brand = document.getElementById('edit-product-brand').value.trim();
            const unit = document.getElementById('edit-product-unit').value;
            const price = parseFloat(document.getElementById('edit-product-price').value);
            const description = document.getElementById('edit-product-desc').value.trim();
            
            if (!name || !price) {
                showToast('Please fill in all required fields', 'error');
                return;
            }
            
            let products = getProducts();
            
            if (id) {
                // Update existing product
                const index = products.findIndex(p => p.id === parseInt(id));
                if (index !== -1) {
                    products[index] = { ...products[index], name, category, brand, unit, price, description };
                }
            } else {
                // Add new product
                const newId = Math.max(...products.map(p => p.id), 0) + 1;
                products.push({
                    id: newId,
                    name,
                    category,
                    brand,
                    unit,
                    price,
                    description,
                    createdAt: new Date().toISOString()
                });
            }
            
            localStorage.setItem(STORAGE_KEYS.PRODUCTS, JSON.stringify(products));
            closePriceModal();
            loadProductPrices();
            updateProductOptions();
            showToast('Product price saved successfully!');
        }
        
        // ==================== ORDER FORM FUNCTIONS ====================
        function updateProductOptions() {
            const category = document.getElementById('category-select').value;
            const productSelect = document.getElementById('product-select');
            
            productSelect.innerHTML = '<option value="">Select Product</option>';
            
            if (!category) return;
            
            const products = getProducts().filter(p => p.category === category);
            
            products.forEach(product => {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = `${product.name} - ₹${product.price}/${product.unit}`;
                option.dataset.price = product.price;
                option.dataset.unit = product.unit;
                productSelect.appendChild(option);
            });
            
            updateUnitAndPrice();
        }
        
        function updateUnitAndPrice() {
            const productSelect = document.getElementById('product-select');
            const selectedOption = productSelect.options[productSelect.selectedIndex];
            
            if (selectedOption && selectedOption.value) {
                const price = selectedOption.dataset.price;
                const unit = selectedOption.dataset.unit;
                
                document.getElementById('unit-price').value = price;
                document.getElementById('unit-select').value = unit;
                calculateAmount();
            } else {
                document.getElementById('unit-price').value = '';
                document.getElementById('unit-select').value = 'bags';
                document.getElementById('order-amount').value = '';
            }
        }
        
        function calculateAmount() {
            const quantity = parseFloat(document.getElementById('material-quantity').value) || 0;
            const unitPrice = parseFloat(document.getElementById('unit-price').value) || 0;
            const productSelect = document.getElementById('product-select');
            const selectedOption = productSelect.options[productSelect.selectedIndex];
            
            if (selectedOption && selectedOption.value && quantity > 0) {
                let amount = quantity * unitPrice;
                
                // Special calculation for rods in pieces
                const productId = parseInt(selectedOption.value);
                const products = getProducts();
                const product = products.find(p => p.id === productId);
                
                if (product && product.category === 'rods' && product.piecesPerBundle) {
                    const piecesPerBundle = product.piecesPerBundle;
                    const selectedUnit = document.getElementById('unit-select').value;
                    
                    if (selectedUnit === 'pcs') {
                        // Calculate price per piece
                        const pricePerPiece = product.price / piecesPerBundle;
                        amount = quantity * pricePerPiece;
                    }
                }
                
                document.getElementById('order-amount').value = amount.toFixed(2);
            } else {
                document.getElementById('order-amount').value = '';
            }
        }
        
        // ==================== PAYMENT FUNCTIONS ====================
        function openPaymentModal() {
            const customers = getCustomers().filter(c => c.balance > 0);
            const select = document.getElementById('payment-customer');
            
            select.innerHTML = '<option value="">Select Customer</option>';
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = `${customer.name} (Balance: ₹${customer.balance}) - ${customer.phone}`;
                option.dataset.balance = customer.balance;
                select.appendChild(option);
            });
            
            // Set max payment amount based on selected customer
            select.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                if (selectedOption.value) {
                    const balance = parseFloat(selectedOption.dataset.balance) || 0;
                    document.getElementById('payment-amount').max = balance;
                    document.getElementById('payment-amount').placeholder = `Max: ₹${balance}`;
                }
            });
            
            document.getElementById('payment-modal').classList.remove('hidden');
        }
        
        function savePayment() {
            const customerId = parseInt(document.getElementById('payment-customer').value);
            const amount = parseFloat(document.getElementById('payment-amount').value) || 0;
            const paymentMode = document.getElementById('payment-mode-select').value;
            const reference = document.getElementById('payment-reference').value.trim();
            
            if (!customerId || amount <= 0) {
                showToast('Please select customer and enter amount', 'error');
                return;
            }
            
            // Get customer
            let customers = getCustomers();
            const customerIndex = customers.findIndex(c => c.id === customerId);
            if (customerIndex === -1) {
                showToast('Customer not found', 'error');
                return;
            }
            
            const customer = customers[customerIndex];
            
            // Validate amount
            if (amount > customer.balance) {
                showToast(`Payment amount (₹${amount}) exceeds balance (₹${customer.balance})`, 'error');
                return;
            }
            
            // Update customer balance
            customer.balance -= amount;
            customer.totalPaid = (customer.totalPaid || 0) + amount;
            customer.updatedAt = new Date().toISOString();
            
            // Update any pending orders for this customer
            updateCustomerOrdersAfterPayment(customerId, amount);
            
            // Create payment record
            const paymentId = Date.now();
            const payment = {
                id: paymentId,
                customerId: customerId,
                customerName: customer.name,
                customerPhone: customer.phone,
                amount: amount,
                paymentMode: paymentMode,
                reference: reference,
                type: 'payment',
                date: new Date().toISOString().split('T')[0],
                timestamp: new Date().toISOString()
            };
            
            // Save payment
            let payments = getPayments();
            payments.push(payment);
            localStorage.setItem(STORAGE_KEYS.PAYMENTS, JSON.stringify(payments));
            
            // Save updated customer
            customers[customerIndex] = customer;
            localStorage.setItem(STORAGE_KEYS.CUSTOMERS, JSON.stringify(customers));
            
            // Update daily report with payment
            updateDailyReportWithPayment(payment);
            
            // Close modal and reset
            document.getElementById('payment-modal').classList.add('hidden');
            document.getElementById('payment-form').reset();
            
            // Show success animation
            playSuccessAnimation('payment');
            
            // Reload data
            loadDashboardData();
            if (document.getElementById('customers-content').classList.contains('hidden') === false) {
                loadAllCustomers();
            }
            if (document.getElementById('payments-content').classList.contains('hidden') === false) {
                loadAllPayments();
            }
            if (document.getElementById('orders-content').classList.contains('hidden') === false) {
                loadAllOrders();
            }
            if (document.getElementById('reports-content').classList.contains('hidden') === false) {
                loadReports();
            }
            
            showToast('Payment recorded successfully!');
        }
        
        function updateCustomerOrdersAfterPayment(customerId, paymentAmount) {
            let orders = getOrders();
            let remainingAmount = paymentAmount;
            
            // Find pending orders for this customer
            const pendingOrders = orders.filter(o => o.customerId === customerId && o.balance > 0)
                                      .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            for (const order of pendingOrders) {
                if (remainingAmount <= 0) break;
                
                const orderIndex = orders.findIndex(o => o.id === order.id);
                if (orderIndex !== -1) {
                    const amountToApply = Math.min(remainingAmount, order.balance);
                    orders[orderIndex].balance -= amountToApply;
                    remainingAmount -= amountToApply;
                    
                    // Update order status
                    if (orders[orderIndex].balance <= 0) {
                        orders[orderIndex].status = 'paid';
                    }
                }
            }
            
            localStorage.setItem(STORAGE_KEYS.ORDERS, JSON.stringify(orders));
        }
        
        // ==================== RECEIPT FUNCTIONS ====================
        function generateReceipt(customer = null, order = null, product = null) {
            if (!customer || !order || !product) {
                // Check if we have items in cart
                if (shoppingCart.length > 0) {
                    // Get customer details from form
                    const customerName = document.getElementById('customer-name').value.trim();
                    const customerPhone = document.getElementById('customer-phone').value.trim();
                    const customerAddress = document.getElementById('customer-address').value.trim();
                    
                    if (!customerName || !customerPhone) {
                        showToast('Please enter customer details before generating receipt', 'error');
                        return;
                    }
                    
                    // Create temporary customer object
                    const tempCustomer = {
                        name: customerName,
                        phone: customerPhone,
                        address: customerAddress
                    };
                    
                    // Create temporary orders from cart
                    const tempOrders = shoppingCart.map(item => ({
                        productName: item.productName,
                        quantity: item.quantity,
                        unit: item.unit,
                        unitPrice: item.unitPrice,
                        amount: item.itemTotal
                    }));
                    
                    // Calculate total
                    const totalAmount = shoppingCart.reduce((sum, item) => sum + item.itemTotal, 0);
                    
                    // Generate cart receipt preview
                    generateCartReceipt(tempCustomer, tempOrders.map((o, i) => ({
                        ...o,
                        id: Date.now() + i,
                        timestamp: new Date().toISOString()
                    })), totalAmount, 'cash', 0);
                    
                    return;
                }
                
                // Get form data for preview
                const customerName = document.getElementById('customer-name').value.trim();
                const customerPhone = document.getElementById('customer-phone').value.trim();
                const productSelect = document.getElementById('product-select');
                const productName = productSelect.options[productSelect.selectedIndex]?.textContent || '';
                const quantity = document.getElementById('material-quantity').value;
                const unit = document.getElementById('unit-select').value;
                const amount = document.getElementById('order-amount').value;
                const paymentMode = document.getElementById('payment-mode').value;
                
                if (!customerName || !customerPhone || !productName) {
                    showToast('Please fill in customer and product details', 'error');
                    return;
                }
                
                currentReceiptData = {
                    customerName,
                    customerPhone,
                    productName,
                    quantity,
                    unit,
                    amount,
                    paymentMode,
                    date: new Date().toLocaleDateString(),
                    time: new Date().toLocaleTimeString(),
                    receiptNo: 'TEMP-' + Date.now().toString().slice(-6)
                };
            } else {
                currentReceiptData = {
                    customerName: customer.name,
                    customerPhone: customer.phone,
                    productName: `${product.name} (${product.brand || ''})`,
                    quantity: order.quantity,
                    unit: order.unit,
                    amount: order.amount,
                    paymentMode: order.paymentMode,
                    date: new Date(order.timestamp).toLocaleDateString(),
                    time: new Date(order.timestamp).toLocaleTimeString(),
                    receiptNo: 'ORD' + order.id.toString().padStart(4, '0'),
                    customerAddress: customer.address,
                    advanceAmount: order.advanceAmount,
                    balance: order.balance,
                    notes: order.notes
                };
            }
            
            // Generate receipt HTML
            const receiptContent = document.getElementById('receipt-content');
            receiptContent.innerHTML = `
                <div class="text-center mb-4">
                    <h2 class="text-2xl font-bold">NAMAN ENTERPRISES</h2>
                    <p class="text-gray-600">Building Materials Supplier</p>
                    <p class="text-sm">Receipt No: ${currentReceiptData.receiptNo}</p>
                </div>
                
                <div class="border-t border-b border-gray-300 py-3 my-3">
                    <div class="flex justify-between mb-2">
                        <span class="font-semibold">Date:</span>
                        <span>${currentReceiptData.date}</span>
                    </div>
                    <div class="flex justify-between mb-2">
                        <span class="font-semibold">Time:</span>
                        <span>${currentReceiptData.time}</span>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h3 class="font-bold text-lg mb-2">Customer Details</h3>
                    <p><strong>Name:</strong> ${currentReceiptData.customerName}</p>
                    <p><strong>Phone:</strong> ${currentReceiptData.customerPhone}</p>
                    ${currentReceiptData.customerAddress ? `<p><strong>Address:</strong> ${currentReceiptData.customerAddress}</p>` : ''}
                </div>
                
                <div class="border-t border-b border-gray-300 py-3 my-3">
                    <h3 class="font-bold text-lg mb-2">Order Details</h3>
                    <div class="flex justify-between mb-2">
                        <span>Product:</span>
                        <span>${currentReceiptData.productName}</span>
                    </div>
                    <div class="flex justify-between mb-2">
                        <span>Quantity:</span>
                        <span>${currentReceiptData.quantity} ${currentReceiptData.unit}</span>
                    </div>
                    <div class="flex justify-between mb-2">
                        <span>Payment Mode:</span>
                        <span class="uppercase">${currentReceiptData.paymentMode}</span>
                    </div>
                </div>
                
                <div class="text-right text-xl font-bold my-4">
                    Total Amount: ₹${currentReceiptData.amount}
                </div>
                
                ${currentReceiptData.advanceAmount ? `
                    <div class="border-t border-gray-300 pt-3">
                        <div class="flex justify-between">
                            <span>Advance Paid:</span>
                            <span>₹${currentReceiptData.advanceAmount}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Balance Due:</span>
                            <span class="font-bold">₹${currentReceiptData.balance}</span>
                        </div>
                    </div>
                ` : ''}
                
                ${currentReceiptData.notes ? `
                    <div class="border-t border-gray-300 pt-3 mt-3">
                        <p><strong>Notes:</strong> ${currentReceiptData.notes}</p>
                    </div>
                ` : ''}
                
                <div class="border-t border-gray-300 pt-4 mt-6 text-center text-sm text-gray-500">
                    <p>Thank you for your business!</p>
                    <p>For any queries, contact: ${document.getElementById('user-name').textContent}</p>
                </div>
            `;
            
            document.getElementById('receipt-modal').classList.remove('hidden');
        }
        
        function printReceipt() {
            const printContent = document.getElementById('receipt-content').innerHTML;
            const originalContent = document.body.innerHTML;
            
            document.body.innerHTML = printContent;
            window.print();
            document.body.innerHTML = originalContent;
            
            // Re-initialize after printing
            document.getElementById('receipt-modal').classList.remove('hidden');
        }
        
        function saveReceipt() {
            if (!currentReceiptData) {
                showToast('No receipt data to save', 'error');
                return;
            }
            
            // Add to master Excel
            const wb = XLSX.utils.book_new();
            const wsData = [
                ['NAMAN ENTERPRISES - RECEIPT'],
                ['Receipt No:', currentReceiptData.receiptNo],
                ['Date:', currentReceiptData.date],
                ['Time:', currentReceiptData.time],
                [],
                ['CUSTOMER DETAILS'],
                ['Name:', currentReceiptData.customerName],
                ['Phone:', currentReceiptData.customerPhone],
                ['Address:', currentReceiptData.customerAddress || ''],
                [],
                ['ORDER DETAILS'],
                ['Product:', currentReceiptData.productName],
                ['Quantity:', `${currentReceiptData.quantity} ${currentReceiptData.unit}`],
                ['Payment Mode:', currentReceiptData.paymentMode.toUpperCase()],
                ['Total Amount:', `₹${currentReceiptData.amount}`],
                ['Advance Paid:', currentReceiptData.advanceAmount ? `₹${currentReceiptData.advanceAmount}` : '₹0'],
                ['Balance Due:', currentReceiptData.balance ? `₹${currentReceiptData.balance}` : '₹0'],
                [],
                ['NOTES'],
                [currentReceiptData.notes || '']
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, 'Receipt');
            
            const date = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `Receipt_${currentReceiptData.receiptNo}_${date}.xlsx`);
            
            showToast('Receipt saved as Excel file');
        }
        
        // ==================== EXCEL EXPORT FUNCTIONS ====================
        function exportMasterExcel() {
            const customers = getCustomers();
            const orders = getOrders();
            const payments = getPayments();
            const products = getProducts();
            
            const wb = XLSX.utils.book_new();
            
            // 1. Customers sheet
            const customerData = [
                ['CUSTOMER MASTER'],
                ['ID', 'Name', 'Phone', 'Address', 'Join Date', 'Total Orders', 'Total Amount', 'Total Paid', 'Balance', 'Last Order']
            ];
            
            customers.forEach(customer => {
                customerData.push([
                    'CUST' + customer.id.toString().padStart(4, '0'),
                    customer.name,
                    customer.phone,
                    customer.address || '',
                    new Date(customer.createdAt).toLocaleDateString(),
                    customer.totalOrders || 0,
                    customer.totalAmount || 0,
                    customer.totalPaid || 0,
                    customer.balance || 0,
                    customer.lastPurchaseDate ? new Date(customer.lastPurchaseDate).toLocaleDateString() : ''
                ]);
            });
            
            // 2. Orders sheet
            const orderData = [
                ['ORDER DETAILS'],
                ['Order ID', 'Customer', 'Phone', 'Product', 'Category', 'Brand', 'Quantity', 'Unit', 'Unit Price', 'Total Amount',
                 'Payment Mode', 'Advance', 'Balance', 'Status', 'Order Date', 'Notes']
            ];
            
            orders.forEach(order => {
                orderData.push([
                    'ORD' + order.id.toString().padStart(4, '0'),
                    order.customerName,
                    order.customerPhone,
                    order.productName,
                    order.productCategory,
                    order.productBrand || '',
                    order.quantity,
                    order.unit,
                    order.unitPrice,
                    order.amount,
                    order.paymentMode,
                    order.advanceAmount || 0,
                    order.balance || 0,
                    order.status,
                    new Date(order.timestamp).toLocaleDateString(),
                    order.notes || ''
                ]);
            });
            
            // 3. Payments sheet
            const paymentData = [
                ['PAYMENT HISTORY'],
                ['Payment ID', 'Customer', 'Phone', 'Amount', 'Payment Mode', 'Reference', 'Date', 'Type']
            ];
            
            payments.forEach(payment => {
                paymentData.push([
                    'PAY' + payment.id.toString().padStart(4, '0'),
                    payment.customerName,
                    payment.customerPhone,
                    payment.amount,
                    payment.paymentMode,
                    payment.reference || '',
                    new Date(payment.timestamp).toLocaleDateString(),
                    payment.type
                ]);
            });
            
            // 4. Products sheet
            const productData = [
                ['PRODUCT MASTER'],
                ['ID', 'Name', 'Category', 'Brand', 'Unit', 'Price', 'Description', 'Created']
            ];
            
            products.forEach(product => {
                productData.push([
                    product.id,
                    product.name,
                    product.category,
                    product.brand || '',
                    product.unit,
                    product.price,
                    product.description || '',
                    product.createdAt ? new Date(product.createdAt).toLocaleDateString() : ''
                ]);
            });
            
            // Create worksheets
            const customerWS = XLSX.utils.aoa_to_sheet(customerData);
            const orderWS = XLSX.utils.aoa_to_sheet(orderData);
            const paymentWS = XLSX.utils.aoa_to_sheet(paymentData);
            const productWS = XLSX.utils.aoa_to_sheet(productData);
            
            // Add to workbook
            XLSX.utils.book_append_sheet(wb, customerWS, 'Customers');
            XLSX.utils.book_append_sheet(wb, orderWS, 'Orders');
            XLSX.utils.book_append_sheet(wb, paymentWS, 'Payments');
            XLSX.utils.book_append_sheet(wb, productWS, 'Products');
            
            // Save file
            const date = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `Naman_Enterprises_Master_Report_${date}.xlsx`);
            
            showToast('Master Excel report downloaded!');
        }
        
        function exportCustomersExcel() {
            const customers = getCustomers();
            
            const data = [
                ['ID', 'Name', 'Phone', 'Address', 'Join Date', 'Total Orders', 'Total Amount', 'Total Paid', 'Balance', 'Last Order']
            ];
            
            customers.forEach(customer => {
                data.push([
                    'CUST' + customer.id.toString().padStart(4, '0'),
                    customer.name,
                    customer.phone,
                    customer.address || '',
                    new Date(customer.createdAt).toLocaleDateString(),
                    customer.totalOrders || 0,
                    customer.totalAmount || 0,
                    customer.totalPaid || 0,
                    customer.balance || 0,
                    customer.lastPurchaseDate ? new Date(customer.lastPurchaseDate).toLocaleDateString() : ''
                ]);
            });
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, 'Customers');
            
            const date = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `Customers_Report_${date}.xlsx`);
            
            showToast('Customers Excel report downloaded!');
        }
        
        function exportOrdersExcel() {
            const orders = getOrders();
            
            const data = [
                ['Order ID', 'Customer', 'Phone', 'Product', 'Quantity', 'Unit', 'Amount', 'Payment Mode', 'Status', 'Date']
            ];
            
            orders.forEach(order => {
                data.push([
                    'ORD' + order.id.toString().padStart(4, '0'),
                    order.customerName,
                    order.customerPhone,
                    order.productName,
                    order.quantity,
                    order.unit,
                    order.amount,
                    order.paymentMode,
                    order.status,
                    new Date(order.timestamp).toLocaleDateString()
                ]);
            });
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, 'Orders');
            
            const date = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `Orders_Report_${date}.xlsx`);
            
            showToast('Orders Excel report downloaded!');
        }
        
        function exportPaymentsExcel() {
            const payments = getPayments();
            
            const data = [
                ['Payment ID', 'Customer', 'Phone', 'Amount', 'Payment Mode', 'Reference', 'Date']
            ];
            
            payments.forEach(payment => {
                data.push([
                    'PAY' + payment.id.toString().padStart(4, '0'),
                    payment.customerName,
                    payment.customerPhone,
                    payment.amount,
                    payment.paymentMode,
                    payment.reference || '',
                    new Date(payment.timestamp).toLocaleDateString()
                ]);
            });
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, 'Payments');
            
            const date = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `Payments_Report_${date}.xlsx`);
            
            showToast('Payments Excel report downloaded!');
        }
        
        function exportCustomerExcel(customerId) {
            const customer = getCustomer(customerId);
            const orders = getOrders().filter(o => o.customerId === customerId);
            const payments = getPayments().filter(p => p.customerId === customerId);
            
            const wb = XLSX.utils.book_new();
            
            // Customer info sheet
            const customerInfo = [
                ['CUSTOMER INFORMATION'],
                ['ID:', 'CUST' + customer.id.toString().padStart(4, '0')],
                ['Name:', customer.name],
                ['Phone:', customer.phone],
                ['Address:', customer.address || ''],
                ['Join Date:', new Date(customer.createdAt).toLocaleDateString()],
                ['Total Orders:', customer.totalOrders || 0],
                ['Total Amount:', customer.totalAmount || 0],
                ['Total Paid:', customer.totalPaid || 0],
                ['Balance:', customer.balance || 0],
                ['Last Order:', customer.lastPurchaseDate ? new Date(customer.lastPurchaseDate).toLocaleDateString() : ''],
                [],
                ['ORDER HISTORY']
            ];
            
            // Orders sheet
            const orderData = [
                ['Order ID', 'Date', 'Product', 'Quantity', 'Unit', 'Unit Price', 'Total Amount', 'Payment Mode', 'Advance', 'Balance', 'Status']
            ];
            
            orders.forEach(order => {
                orderData.push([
                    'ORD' + order.id.toString().padStart(4, '0'),
                    new Date(order.timestamp).toLocaleDateString(),
                    order.productName,
                    order.quantity,
                    order.unit,
                    order.unitPrice,
                    order.amount,
                    order.paymentMode,
                    order.advanceAmount || 0,
                    order.balance || 0,
                    order.status
                ]);
            });
            
            // Payments sheet
            const paymentData = [
                ['Payment ID', 'Date', 'Amount', 'Payment Mode', 'Reference', 'Type']
            ];
            
            payments.forEach(payment => {
                paymentData.push([
                    'PAY' + payment.id.toString().padStart(4, '0'),
                    new Date(payment.timestamp).toLocaleDateString(),
                    payment.amount,
                    payment.paymentMode,
                    payment.reference || '',
                    payment.type
                ]);
            });
            
            // Create worksheets
            const customerWS = XLSX.utils.aoa_to_sheet(customerInfo);
            const orderWS = XLSX.utils.aoa_to_sheet(orderData);
            const paymentWS = XLSX.utils.aoa_to_sheet(paymentData);
            
            XLSX.utils.book_append_sheet(wb, customerWS, 'Customer Info');
            XLSX.utils.book_append_sheet(wb, orderWS, 'Orders');
            XLSX.utils.book_append_sheet(wb, paymentWS, 'Payments');
            
            const filename = `${customer.name.replace(/[^a-z0-9]/gi, '_')}_Report_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename);
            
            showToast(`Customer Excel report for ${customer.name} downloaded!`);
        }
        
        // ==================== REPORT FUNCTIONS ====================
        function loadReports() {
            const dailyReports = getDailyReports();
            const container = document.getElementById('daily-report-table');
            
            if (dailyReports.length === 0) {
                container.innerHTML = `
                    <tr>
                        <td colspan="6" class="py-8 text-center text-gray-500">
                            <i class="fas fa-chart-bar text-3xl mb-2 block mx-auto"></i>
                            <p>No reports available</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            container.innerHTML = '';
            dailyReports.forEach(report => {
                const row = document.createElement('tr');
                row.className = 'table-row fade-in';
                
                // Calculate payments received for this date
                const payments = getPayments();
                const dailyPayments = payments.filter(p => p.date === report.date);
                const totalPayments = dailyPayments.reduce((sum, p) => sum + p.amount, 0);
                
                row.innerHTML = `
                    <td class="py-3 px-4">${report.date}</td>
                    <td class="py-3 px-4 text-center">${report.totalOrders || 0}</td>
                    <td class="py-3 px-4">₹${report.totalAmount || 0}</td>
                    <td class="py-3 px-4">₹${totalPayments}</td>
                    <td class="py-3 px-4 text-center">${report.newCustomers || 0}</td>
                    <td class="py-3 px-4">
                        <button onclick="viewDailyReport('${report.date}')" class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
                container.appendChild(row);
            });
            
            // Update sales summary
            updateSalesSummary();
            updateProductSales();
        }
        
        function generateReport() {
            const startDate = document.getElementById('report-start-date').value;
            const endDate = document.getElementById('report-end-date').value;
            
            if (!startDate || !endDate) {
                showToast('Please select start and end dates', 'error');
                return;
            }
            
            const orders = getOrders().filter(o => o.date >= startDate && o.date <= endDate);
            const payments = getPayments().filter(p => p.date >= startDate && p.date <= endDate);
            const customers = getCustomers().filter(c => {
                const joinDate = c.createdAt.split('T')[0];
                return joinDate >= startDate && joinDate <= endDate;
            });
            
            // Generate report data
            const totalOrders = orders.length;
            const totalAmount = orders.reduce((sum, o) => sum + o.amount, 0);
            const totalPayments = payments.reduce((sum, p) => sum + p.amount, 0);
            const newCustomers = customers.length;
            
            // Show in modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 modal-overlay flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-2xl w-full mx-4">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800">Report: ${startDate} to ${endDate}</h3>
                        <button onclick="this.closest('.modal-overlay').remove()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <div class="text-sm text-blue-600">Total Orders</div>
                            <div class="text-2xl font-bold">${totalOrders}</div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <div class="text-sm text-green-600">Total Amount</div>
                            <div class="text-2xl font-bold">₹${totalAmount}</div>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <div class="text-sm text-purple-600">Payments Received</div>
                            <div class="text-2xl font-bold">₹${totalPayments}</div>
                        </div>
                        <div class="bg-yellow-50 p-4 rounded-lg">
                            <div class="text-sm text-yellow-600">New Customers</div>
                            <div class="text-2xl font-bold">${newCustomers}</div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end">
                        <button onclick="exportDateRangeReport('${startDate}', '${endDate}')" class="btn-success">
                            <i class="fas fa-file-excel mr-2"></i>Export Report
                        </button>
                    </div>
                </div>
            `;
            
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    document.body.removeChild(this);
                }
            });
            
            document.body.appendChild(modal);
        }
        
        function exportDateRangeReport(startDate, endDate) {
            const orders = getOrders().filter(o => o.date >= startDate && o.date <= endDate);
            const payments = getPayments().filter(p => p.date >= startDate && p.date <= endDate);
            
            const wb = XLSX.utils.book_new();
            
            // Orders sheet
            const orderData = [
                ['Order ID', 'Date', 'Customer', 'Phone', 'Product', 'Quantity', 'Unit', 'Amount', 'Payment Mode', 'Status']
            ];
            
            orders.forEach(order => {
                orderData.push([
                    'ORD' + order.id.toString().padStart(4, '0'),
                    order.date,
                    order.customerName,
                    order.customerPhone,
                    order.productName,
                    order.quantity,
                    order.unit,
                    order.amount,
                    order.paymentMode,
                    order.status
                ]);
            });
            
            // Payments sheet
            const paymentData = [
                ['Payment ID', 'Date', 'Customer', 'Phone', 'Amount', 'Payment Mode', 'Reference']
            ];
            
            payments.forEach(payment => {
                paymentData.push([
                    'PAY' + payment.id.toString().padStart(4, '0'),
                    payment.date,
                    payment.customerName,
                    payment.customerPhone,
                    payment.amount,
                    payment.paymentMode,
                    payment.reference || ''
                ]);
            });
            
            const orderWS = XLSX.utils.aoa_to_sheet(orderData);
            const paymentWS = XLSX.utils.aoa_to_sheet(paymentData);
            
            XLSX.utils.book_append_sheet(wb, orderWS, 'Orders');
            XLSX.utils.book_append_sheet(wb, paymentWS, 'Payments');
            
            XLSX.writeFile(wb, `Report_${startDate}_to_${endDate}.xlsx`);
            
            showToast('Date range report exported!');
        }
        
        function updateSalesSummary() {
            const orders = getOrders();
            const payments = getPayments();
            const customers = getCustomers();
            
            const today = new Date().toISOString().split('T')[0];
            const thisMonth = today.substring(0, 7);
            
            const todayOrders = orders.filter(o => o.date === today);
            const monthOrders = orders.filter(o => o.date.startsWith(thisMonth));
            
            const todaySales = todayOrders.reduce((sum, o) => sum + o.amount, 0);
            const monthSales = monthOrders.reduce((sum, o) => sum + o.amount, 0);
            const totalSales = orders.reduce((sum, o) => sum + o.amount, 0);
            const totalPayments = payments.reduce((sum, p) => sum + p.amount, 0);
            const pendingPayments = customers.reduce((sum, c) => sum + (c.balance || 0), 0);
            
            const container = document.getElementById('sales-summary');
            container.innerHTML = `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded slide-up">
                    <span>Today's Sales:</span>
                    <span class="font-bold">₹${todaySales}</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded slide-up">
                    <span>This Month:</span>
                    <span class="font-bold">₹${monthSales}</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded slide-up">
                    <span>Total Sales:</span>
                    <span class="font-bold">₹${totalSales}</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded slide-up">
                    <span>Total Payments:</span>
                    <span class="font-bold">₹${totalPayments}</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded slide-up">
                    <span>Pending Payments:</span>
                    <span class="font-bold text-red-600">₹${pendingPayments}</span>
                </div>
            `;
        }
        
        function updateProductSales() {
            const orders = getOrders();
            const productSales = {};
            
            orders.forEach(order => {
                const productName = order.productName;
                if (!productSales[productName]) {
                    productSales[productName] = { quantity: 0, amount: 0 };
                }
                productSales[productName].quantity += order.quantity;
                productSales[productName].amount += order.amount;
            });
            
            const container = document.getElementById('product-sales');
            let html = '';
            
            Object.entries(productSales).forEach(([product, data]) => {
                html += `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded slide-up">
                        <div>
                            <div class="font-medium">${product}</div>
                            <div class="text-sm text-gray-600">${data.quantity} units</div>
                        </div>
                        <div class="font-bold">₹${data.amount}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html || '<p class="text-gray-500 slide-up">No product sales data</p>';
        }
        
        // ==================== DATA STORAGE HELPERS ====================
        function getCustomers() {
            return JSON.parse(localStorage.getItem(STORAGE_KEYS.CUSTOMERS)) || [];
        }
        
        function getCustomer(id) {
            const customers = getCustomers();
            return customers.find(c => c.id === id);
        }
        
        function getOrders() {
            return JSON.parse(localStorage.getItem(STORAGE_KEYS.ORDERS)) || [];
        }
        
        function getPayments() {
            return JSON.parse(localStorage.getItem(STORAGE_KEYS.PAYMENTS)) || [];
        }
        
        function getProducts() {
            return JSON.parse(localStorage.getItem(STORAGE_KEYS.PRODUCTS)) || DEFAULT_PRODUCTS;
        }
        
        function getDailyReports() {
            const reports = JSON.parse(localStorage.getItem(STORAGE_KEYS.DAILY_REPORTS)) || [];
            return reports.sort((a, b) => b.date.localeCompare(a.date));
        }
        
        function saveToCustomerExcel(customer, order) {
            let customerExcel = JSON.parse(localStorage.getItem(STORAGE_KEYS.CUSTOMER_EXCEL)) || {};
            
            if (!customerExcel[customer.id]) {
                customerExcel[customer.id] = {
                    customerInfo: {
                        id: customer.id,
                        name: customer.name,
                        phone: customer.phone,
                        address: customer.address,
                        joinDate: customer.createdAt
                    },
                    orders: [],
                    payments: []
                };
            }
            
            // Add order
            customerExcel[customer.id].orders.push({
                orderId: order.id,
                date: order.date,
                time: new Date(order.timestamp).toLocaleTimeString(),
                productName: order.productName,
                quantity: order.quantity,
                unit: order.unit,
                amount: order.amount,
                paymentMode: order.paymentMode,
                advanceAmount: order.advanceAmount,
                balance: order.balance,
                notes: order.notes
            });
            
            localStorage.setItem(STORAGE_KEYS.CUSTOMER_EXCEL, JSON.stringify(customerExcel));
        }
        
        function updateDailyReport(order) {
            const date = order.date;
            let reports = getDailyReports();
            let report = reports.find(r => r.date === date);
            
            if (!report) {
                report = {
                    date: date,
                    totalOrders: 0,
                    totalAmount: 0,
                    newCustomers: 0
                };
                reports.push(report);
            }
            
            report.totalOrders = (report.totalOrders || 0) + 1;
            report.totalAmount = (report.totalAmount || 0) + order.amount;
            
            // Update new customers count
            const customers = getCustomers();
            const newCustomersToday = customers.filter(c => {
                const joinDate = c.createdAt.split('T')[0];
                return joinDate === date;
            }).length;
            report.newCustomers = newCustomersToday;
            
            localStorage.setItem(STORAGE_KEYS.DAILY_REPORTS, JSON.stringify(reports));
        }
        
        function updateDailyReportWithPayment(payment) {
            const date = payment.date;
            let reports = getDailyReports();
            let report = reports.find(r => r.date === date);
            
            if (!report) {
                report = {
                    date: date,
                    totalOrders: 0,
                    totalAmount: 0,
                    newCustomers: 0
                };
                reports.push(report);
            }
            
            // Note: Payments are tracked separately in loadReports()
            localStorage.setItem(STORAGE_KEYS.DAILY_REPORTS, JSON.stringify(reports));
        }
        
        // ==================== UTILITY FUNCTIONS ====================
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const messageEl = document.getElementById('toast-message');
            
            messageEl.textContent = message;
            if (type === 'error') {
                toast.className = 'fixed bottom-4 right-4 bg-red-600 text-white px-4 py-3 rounded-lg shadow-lg z-50 transform translate-y-20 transition-transform';
            } else {
                toast.className = 'fixed bottom-4 right-4 bg-green-600 text-white px-4 py-3 rounded-lg shadow-lg z-50 transform translate-y-20 transition-transform';
            }
            
            toast.classList.remove('translate-y-20');
            
            setTimeout(() => {
                toast.classList.add('translate-y-20');
            }, 3000);
        }
        
        function openSearchModal() {
            document.getElementById('search-modal').classList.remove('hidden');
            document.getElementById('search-input').focus();
        }
        
        function searchCustomers(query) {
            const customers = getCustomers();
            const resultsContainer = document.getElementById('search-results');
            
            if (!query.trim()) {
                const recentCustomers = customers.slice(-10).reverse();
                displaySearchResults(recentCustomers);
                return;
            }
            
            const filtered = customers.filter(customer =>
                customer.name.toLowerCase().includes(query.toLowerCase()) ||
                customer.phone.includes(query)
            );
            
            displaySearchResults(filtered);
        }
        
        function displaySearchResults(customers) {
            const container = document.getElementById('search-results');
            
            if (customers.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4 text-gray-500">
                        <i class="fas fa-search text-3xl mb-2"></i>
                        <p>No customers found</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            customers.forEach(customer => {
                const div = document.createElement('div');
                div.className = 'p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition cursor-pointer slide-up';
                div.addEventListener('click', function() {
                    document.getElementById('search-modal').classList.add('hidden');
                    document.getElementById('customer-name').value = customer.name;
                    document.getElementById('customer-phone').value = customer.phone;
                    document.getElementById('customer-address').value = customer.address || '';
                    document.getElementById('customer-order-form').scrollIntoView({ behavior: 'smooth' });
                });
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-semibold text-gray-800">${customer.name}</h4>
                            <p class="text-sm text-gray-600">${customer.phone}</p>
                            <p class="text-sm text-gray-500 mt-1">${customer.address || 'No address'}</p>
                        </div>
                        <div class="text-right">
                            <div class="font-medium ${customer.balance > 0 ? 'text-red-600' : 'text-green-600'}">
                                Balance: ₹${customer.balance || 0}
                            </div>
                            <div class="text-sm text-gray-500">
                                Orders: ${customer.totalOrders || 0}
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        
        // ==================== ANIMATION FUNCTIONS ====================
        function playSuccessAnimation(type) {
            // Add pulse animation to relevant stat card
            if (type === 'customer' || type === 'order') {
                const todaySalesCard = document.querySelector('#today-sales').closest('.stat-card');
                const totalRevenueCard = document.querySelector('#total-revenue').closest('.stat-card');
                
                todaySalesCard.classList.add('pulse-success');
                setTimeout(() => todaySalesCard.classList.remove('pulse-success'), 2000);
            } else if (type === 'payment') {
                const pendingPaymentsCard = document.querySelector('#pending-payments').closest('.stat-card');
                pendingPaymentsCard.classList.add('pulse-success');
                setTimeout(() => pendingPaymentsCard.classList.remove('pulse-success'), 2000);
            }
        }
        
        function playDeleteAnimation() {
            // Shake animation for deleted row
            const deletedRows = document.querySelectorAll('.table-row');
            if (deletedRows.length > 0) {
                deletedRows[deletedRows.length - 1].style.animation = 'shake 0.5s ease-in-out';
                setTimeout(() => {
                    if (deletedRows[deletedRows.length - 1]) {
                        deletedRows[deletedRows.length - 1].style.animation = '';
                    }
                }, 500);
            }
        }
        
        // ==================== DELETE FUNCTIONS ====================
        function deleteOrder(orderId) {
            if (!confirm('Are you sure you want to delete this order?')) return;
            
            let orders = getOrders();
            const orderIndex = orders.findIndex(o => o.id === orderId);
            
            if (orderIndex === -1) {
                showToast('Order not found', 'error');
                return;
            }
            
            const order = orders[orderIndex];
            
            // Update customer balance
            let customers = getCustomers();
            const customerIndex = customers.findIndex(c => c.id === order.customerId);
            
            if (customerIndex !== -1) {
                const customer = customers[customerIndex];
                customer.totalOrders -= 1;
                customer.totalAmount -= order.amount;
                customer.totalPaid -= (order.amount - order.balance);
                customer.balance -= order.balance;
                
                // Update customer
                customers[customerIndex] = customer;
                localStorage.setItem(STORAGE_KEYS.CUSTOMERS, JSON.stringify(customers));
            }
            
            // Remove order
            orders.splice(orderIndex, 1);
            localStorage.setItem(STORAGE_KEYS.ORDERS, JSON.stringify(orders));
            
            // Remove associated payments
            let payments = getPayments();
            payments = payments.filter(p => p.orderId !== orderId);
            localStorage.setItem(STORAGE_KEYS.PAYMENTS, JSON.stringify(payments));
            
            // Update daily report
            const reports = getDailyReports();
            const reportIndex = reports.findIndex(r => r.date === order.date);
            if (reportIndex !== -1) {
                reports[reportIndex].totalOrders = Math.max(0, (reports[reportIndex].totalOrders || 0) - 1);
                reports[reportIndex].totalAmount = Math.max(0, (reports[reportIndex].totalAmount || 0) - order.amount);
                localStorage.setItem(STORAGE_KEYS.DAILY_REPORTS, JSON.stringify(reports));
            }
            
            // Update dashboard
            loadDashboardData();
            loadAllOrders();
            
            showToast('Order deleted successfully');
        }
        
        function deletePayment(paymentId) {
            if (!confirm('Are you sure you want to delete this payment?')) return;
            
            let payments = getPayments();
            const paymentIndex = payments.findIndex(p => p.id === paymentId);
            
            if (paymentIndex === -1) {
                showToast('Payment not found', 'error');
                return;
            }
            
            const payment = payments[paymentIndex];
            
            // Update customer balance
            let customers = getCustomers();
            const customerIndex = customers.findIndex(c => c.id === payment.customerId);
            
            if (customerIndex !== -1) {
                const customer = customers[customerIndex];
                customer.totalPaid -= payment.amount;
                customer.balance += payment.amount;
                
                // Update customer
                customers[customerIndex] = customer;
                localStorage.setItem(STORAGE_KEYS.CUSTOMERS, JSON.stringify(customers));
                
                // Update customer orders balance
                updateCustomerOrdersAfterPaymentDelete(payment.customerId, payment.amount);
            }
            
            // Remove payment
            payments.splice(paymentIndex, 1);
            localStorage.setItem(STORAGE_KEYS.PAYMENTS, JSON.stringify(payments));
            
            // Update dashboard
            loadDashboardData();
            loadAllPayments();
            if (document.getElementById('reports-content').classList.contains('hidden') === false) {
                loadReports();
            }
            
            showToast('Payment deleted successfully');
        }
        
        function updateCustomerOrdersAfterPaymentDelete(customerId, paymentAmount) {
            let orders = getOrders();
            let amountToRestore = paymentAmount;
            
            // Find paid orders for this customer (reverse chronological order)
            const paidOrders = orders.filter(o => o.customerId === customerId && o.balance < o.amount)
                                   .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            for (const order of paidOrders) {
                if (amountToRestore <= 0) break;
                
                const orderIndex = orders.findIndex(o => o.id === order.id);
                if (orderIndex !== -1) {
                    const originalBalance = order.amount - (order.totalPaid || 0);
                    const amountToRestoreForOrder = Math.min(amountToRestore, order.amount - order.balance);
                    
                    orders[orderIndex].balance += amountToRestoreForOrder;
                    amountToRestore -= amountToRestoreForOrder;
                    
                    // Update order status
                    if (orders[orderIndex].balance > 0) {
                        orders[orderIndex].status = orders[orderIndex].paymentMode === 'partial' ? 'partial' : 'pending';
                    }
                }
            }
            
            localStorage.setItem(STORAGE_KEYS.ORDERS, JSON.stringify(orders));
        }
        
        // ==================== VIEW FUNCTIONS ====================
        function viewOrderReceipt(orderId) {
            const orders = getOrders();
            const order = orders.find(o => o.id === orderId);
            
            if (!order) {
                showToast('Order not found', 'error');
                return;
            }
            
            const customers = getCustomers();
            const customer = customers.find(c => c.id === order.customerId);
            
            const products = getProducts();
            const product = products.find(p => p.id === order.productId);
            
            generateReceipt(customer, order, product);
        }
        
        function viewDailyReport(date) {
            const orders = getOrders().filter(o => o.date === date);
            const payments = getPayments().filter(p => p.date === date);
            const customers = getCustomers().filter(c => c.createdAt.split('T')[0] === date);
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 modal-overlay flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-4xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800">Daily Report - ${date}</h3>
                            <p class="text-gray-600">Detailed transaction report</p>
                        </div>
                        <button onclick="this.closest('.modal-overlay').remove()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <div class="text-sm text-blue-600">Total Orders</div>
                            <div class="text-2xl font-bold">${orders.length}</div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <div class="text-sm text-green-600">Total Amount</div>
                            <div class="text-2xl font-bold">₹${orders.reduce((sum, o) => sum + o.amount, 0)}</div>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <div class="text-sm text-purple-600">Payments</div>
                            <div class="text-2xl font-bold">₹${payments.reduce((sum, p) => sum + p.amount, 0)}</div>
                        </div>
                        <div class="bg-yellow-50 p-4 rounded-lg">
                            <div class="text-sm text-yellow-600">New Customers</div>
                            <div class="text-2xl font-bold">${customers.length}</div>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h4 class="font-semibold text-gray-700 mb-3">Orders on ${date}</h4>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="py-2 px-3 text-left text-sm">Time</th>
                                        <th class="py-2 px-3 text-left text-sm">Customer</th>
                                        <th class="py-2 px-3 text-left text-sm">Product</th>
                                        <th class="py-2 px-3 text-left text-sm">Amount</th>
                                        <th class="py-2 px-3 text-left text-sm">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${orders.map(order => `
                                        <tr class="border-t">
                                            <td class="py-2 px-3">${new Date(order.timestamp).toLocaleTimeString()}</td>
                                            <td class="py-2 px-3">${order.customerName}</td>
                                            <td class="py-2 px-3">${order.productName}</td>
                                            <td class="py-2 px-3">₹${order.amount}</td>
                                            <td class="py-2 px-3">
                                                <span class="px-2 py-1 text-xs rounded-full ${order.balance > 0 ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                                                    ${order.balance > 0 ? 'Pending' : 'Paid'}
                                                </span>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    document.body.removeChild(this);
                }
            });
            
            document.body.appendChild(modal);
        }
        
        function showManagePrices() {
            showSection('prices');
        }
        
        // ==================== KEYBOARD SHORTCUTS ====================
        document.addEventListener('keydown', function(e) {
            // Ctrl + S to add to cart
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                addToCart();
            }
            
            // Ctrl + F to search
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                openSearchModal();
            }
            
            // Escape to close modals
            if (e.key === 'Escape') {
                document.getElementById('search-modal').classList.add('hidden');
                document.getElementById('payment-modal').classList.add('hidden');
                document.getElementById('receipt-modal').classList.add('hidden');
                document.getElementById('price-modal').classList.add('hidden');
                document.getElementById('checkout-modal').classList.add('hidden');
            }
        });
    </script>
</body>
</html>